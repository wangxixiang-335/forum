import{d as he,r as d,i as g,l as fe,x as be,w as ge,c as a,a as s,b as c,k,q as K,s as ye,n as R,f as B,t as r,j as U,v as A,F as V,g as N,K as Ce,m as ne,e as H,E as le,h as n,_ as we}from"./index-DvT1nwGZ.js";import{useAuthStore as xe}from"./auth-hIVPxf3j.js";import{u as Me}from"./messages-C7dDKSwE.js";import{u as $e}from"./bookmarks-QnlEBPDt.js";import{U as E}from"./UserAvatar-xuan3Pxw.js";const Be={class:"message-center"},Ue={class:"header"},Ve={class:"container"},Ne={class:"header-nav"},Se={class:"nav"},Te={key:0,class:"unread-indicator"},Fe={class:"main"},De={class:"container"},ze={class:"message-layout"},Ke={class:"sidebar"},Re={class:"sidebar-tabs"},Ae={key:0,class:"unread-badge"},Ee={key:0,class:"conversation-list"},Le={class:"search-box"},He={key:0,class:"search-results"},Pe=["onClick"],je={key:0,class:"empty-state"},qe=["onClick"],Qe={class:"conversation-info"},Ge={class:"conversation-header"},Ie={class:"username"},Je={class:"time"},Oe={class:"last-message"},We={class:"conversation-meta"},Xe={key:0,class:"unread-count"},Ye={key:1,class:"bookmark-list"},Ze={class:"folder-selector"},es=["value"],ss={key:0,class:"empty-state"},ts=["onClick"],os={class:"bookmark-content"},as={key:0},ns={class:"bookmark-excerpt"},ls={class:"bookmark-meta"},rs={class:"bookmark-type"},is={class:"bookmark-time"},us={class:"bookmark-actions"},cs=["onClick"],ds={class:"content"},vs={key:0,class:"conversation-view"},_s={key:0,class:"empty-conversation"},ms={key:1,class:"chat-container"},ks={class:"chat-header"},ps={class:"chat-username"},hs={class:"message-content"},fs={class:"message-bubble"},bs={class:"message-time"},gs={class:"message-input"},ys={class:"input-wrapper"},Cs=["onKeydown"],ws={class:"input-actions"},xs=["disabled"],Ms={key:1,class:"bookmark-view"},$s={key:0,class:"empty-bookmark"},Bs={key:1,class:"bookmark-detail"},Us={class:"bookmark-header"},Vs={key:0},Ns={class:"bookmark-info"},Ss={class:"bookmark-type"},Ts={class:"bookmark-folder"},Fs={class:"bookmark-time"},Ds={class:"bookmark-content-full"},zs={class:"bookmark-note"},Ks={class:"bookmark-actions"},Rs={class:"modal-content"},As={class:"modal-actions"},Es=["disabled"],Ls=he({__name:"MessageCenterView",setup(Hs){const P=be(),S=xe(),v=Me(),p=$e(),m=d("conversations"),h=d(""),i=d(null),y=d(""),w=d(""),x=d([]),L=d("é»˜è®¤æ”¶è—å¤¹"),T=d(""),M=d(!1),C=d(""),f=d(),$=g(()=>{const o=v.conversations;return console.log("conversations computed:",o.length,o),o}),re=g(()=>v.currentMessages),F=g(()=>v.unreadCount),j=g(()=>p.bookmarks),ie=g(()=>p.folders),ue=g(()=>{var o;return((o=S.user)==null?void 0:o.id)||""}),D=g(()=>$.value.find(o=>o.id===h.value));fe(()=>{q()});const q=async()=>{try{if(!S.isAuthenticated){console.warn("ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢"),P.push("/login");return}console.log("å¼€å§‹åŠ è½½æ¶ˆæ¯ä¸­å¿ƒæ•°æ®..."),await Promise.all([v.fetchConversations().catch(o=>(console.error("è·å–ä¼šè¯å¤±è´¥:",o),{success:!1})),v.fetchUnreadCount().catch(o=>(console.error("è·å–æœªè¯»æ•°é‡å¤±è´¥:",o),{success:!1})),p.fetchFolders().catch(o=>(console.error("è·å–æ”¶è—å¤¹å¤±è´¥:",o),{success:!1})),Q().catch(o=>(console.error("åŠ è½½æ”¶è—å¤±è´¥:",o),{success:!1}))]),console.log("æ¶ˆæ¯ä¸­å¿ƒæ•°æ®åŠ è½½å®Œæˆ")}catch(o){console.error("åŠ è½½åˆå§‹æ•°æ®å¤±è´¥:",o)}},Q=async()=>{await p.fetchBookmarks(L.value)},G=async o=>{console.log("é€‰æ‹©å¯¹è¯:",o),h.value=o;const e=await v.fetchMessages(o);console.log("è·å–æ¶ˆæ¯ç»“æœ:",e);const l=$.value.find(u=>u.id===o);console.log("æ‰¾åˆ°çš„å¯¹è¯:",l),l&&l.other_user?(console.log("å¯¹è¯çš„other_user:",l.other_user),console.log("other_user.id:",l.other_user.id),l.other_user.id?await v.markMessagesAsRead(l.other_user.id):console.warn("other_user.id ä¸ºç©ºï¼Œè·³è¿‡æ ‡è®°å·²è¯»")):console.warn("å¯¹è¯æˆ–other_userä¸å­˜åœ¨:",{conversation:l,conversationId:o}),le(()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight)})},I=async()=>{if(!y.value.trim())return;const o=D.value;if(!o||!o.other_user)return;const e=await v.sendMessage(o.other_user.id,y.value.trim());e.success?(y.value="",le(()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight)})):alert("å‘é€å¤±è´¥: "+e.error)},ce=async()=>{if(!w.value.trim()){x.value=[];return}const o=await v.searchUsers(w.value.trim());o.success&&(x.value=o.data)},de=async o=>{x.value=[],w.value="";const e=$.value.find(l=>{var u;return((u=l.other_user)==null?void 0:u.id)===o.id});e?G(e.id):alert("ä¼šè¯åŠŸèƒ½å°†åœ¨å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶è‡ªåŠ¨åˆ›å»º")},ve=async()=>{if(!h.value||!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ"))return;const o=await v.deleteConversation(h.value);o.success?h.value="":alert("åˆ é™¤å¤±è´¥: "+o.error)},_e=o=>{i.value=o,T.value=o.note||""},J=async o=>{var l;if(!confirm("ç¡®å®šè¦å–æ¶ˆæ”¶è—å—ï¼Ÿ"))return;const e=await p.removeBookmark(o);e.success?((l=i.value)==null?void 0:l.id)===o&&(i.value=null):alert("å–æ¶ˆæ”¶è—å¤±è´¥: "+e.error)},me=async()=>{i.value&&await p.updateBookmarkNote(i.value.id,T.value)},O=async()=>{if(!C.value.trim())return;const o=p.createFolder(C.value.trim());o.success?(C.value="",M.value=!1):alert("åˆ›å»ºæ”¶è—å¤¹å¤±è´¥: "+o.error)},ke=o=>{P.push(`/post/${o}`)},pe=o=>{var l;const e=((l=o.target_data)==null?void 0:l.content)||"";return e.length>100?e.substring(0,100)+"...":e},z=o=>{const e=new Date(o),u=new Date().getTime()-e.getTime();return u<6e4?"åˆšåˆš":u<36e5?`${Math.floor(u/6e4)}åˆ†é’Ÿå‰`:u<864e5?`${Math.floor(u/36e5)}å°æ—¶å‰`:u<6048e5?`${Math.floor(u/864e5)}å¤©å‰`:e.toLocaleDateString("zh-CN")};return ge(()=>S.user,()=>{S.user&&q()},{immediate:!0}),(o,e)=>{var u,W,X,Y,Z,ee,se,te;const l=ye("RouterLink");return n(),a("div",Be,[s("header",Ue,[s("div",Ve,[s("div",Ne,[k(l,{to:"/",class:"back-link"},{default:K(()=>[...e[12]||(e[12]=[B("â† è¿”å›é¦–é¡µ",-1)])]),_:1}),s("nav",Se,[k(l,{to:"/profile",class:"nav-link"},{default:K(()=>[...e[13]||(e[13]=[s("i",{class:"bi bi-person"},null,-1),B(" ä¸ªäººä¸­å¿ƒ ",-1)])]),_:1}),k(l,{to:"/bookmarks",class:"nav-link"},{default:K(()=>[...e[14]||(e[14]=[s("i",{class:"bi bi-bookmark"},null,-1),B(" æ”¶è— ",-1)])]),_:1}),k(l,{to:"/messages",class:"nav-link active"},{default:K(()=>[e[15]||(e[15]=s("i",{class:"bi bi-envelope"},null,-1)),e[16]||(e[16]=B(" æ¶ˆæ¯ ",-1)),F.value>0?(n(),a("span",Te,r(F.value),1)):c("",!0)]),_:1})])]),e[17]||(e[17]=s("h1",null,"æ¶ˆæ¯ä¸­å¿ƒ",-1))])]),s("main",Fe,[s("div",De,[s("div",ze,[s("aside",Ke,[s("div",Re,[s("button",{class:R(["tab-btn",{active:m.value==="conversations"}]),onClick:e[0]||(e[0]=t=>m.value="conversations")},[e[18]||(e[18]=B(" ğŸ’¬ ç§ä¿¡ ",-1)),F.value>0?(n(),a("span",Ae,r(F.value),1)):c("",!0)],2),s("button",{class:R(["tab-btn",{active:m.value==="bookmarks"}]),onClick:e[1]||(e[1]=t=>m.value="bookmarks")}," ğŸ”– æ”¶è— ",2)]),m.value==="conversations"?(n(),a("div",Ee,[s("div",Le,[U(s("input",{"onUpdate:modelValue":e[2]||(e[2]=t=>w.value=t),type:"text",placeholder:"æœç´¢ç”¨æˆ·...",onInput:ce},null,544),[[A,w.value]]),x.value.length>0?(n(),a("div",He,[(n(!0),a(V,null,N(x.value,t=>(n(),a("div",{key:t.id,class:"search-result-item",onClick:_=>de(t)},[k(E,{username:t.username,"avatar-id":t.avatar_url,size:"32px"},null,8,["username","avatar-id"]),s("span",null,r(t.username),1)],8,Pe))),128))])):c("",!0)]),$.value.length===0?(n(),a("div",je,[...e[19]||(e[19]=[s("p",null,"æš‚æ— ç§ä¿¡å¯¹è¯",-1)])])):c("",!0),(n(!0),a(V,null,N($.value,t=>{var _,b,oe,ae;return n(),a("div",{key:t.id,class:R(["conversation-item",{active:h.value===t.id}]),onClick:Ps=>G(t.id)},[k(E,{username:((_=t.other_user)==null?void 0:_.username)||"ç”¨æˆ·","avatar-id":(b=t.other_user)==null?void 0:b.avatar_url,size:"40px"},null,8,["username","avatar-id"]),s("div",Qe,[s("div",Ge,[s("span",Ie,r((oe=t.other_user)==null?void 0:oe.username),1),s("span",Je,r(z(t.last_message_at)),1)]),s("div",Oe,r(((ae=t.last_message)==null?void 0:ae.content)||"æš‚æ— æ¶ˆæ¯"),1)]),s("div",We,[t.unread_count>0?(n(),a("span",Xe,r(t.unread_count),1)):c("",!0)])],10,qe)}),128))])):c("",!0),m.value==="bookmarks"?(n(),a("div",Ye,[s("div",Ze,[U(s("select",{"onUpdate:modelValue":e[3]||(e[3]=t=>L.value=t),onChange:Q},[(n(!0),a(V,null,N(ie.value,t=>(n(),a("option",{key:t,value:t},r(t),9,es))),128))],544),[[Ce,L.value]]),s("button",{onClick:e[4]||(e[4]=t=>M.value=!0),class:"create-folder-btn"}," + æ–°å»ºæ–‡ä»¶å¤¹ ")]),j.value.length===0?(n(),a("div",ss,[...e[20]||(e[20]=[s("p",null,"æš‚æ— æ”¶è—å†…å®¹",-1)])])):c("",!0),(n(!0),a(V,null,N(j.value,t=>{var _;return n(),a("div",{key:t.id,class:"bookmark-item",onClick:b=>_e(t)},[s("div",os,[t.target_type==="post"?(n(),a("h4",as,r((_=t.target_data)==null?void 0:_.title),1)):c("",!0),s("p",ns,r(pe(t)),1),s("div",ls,[s("span",rs,r(t.target_type==="post"?"å¸–å­":"è¯„è®º"),1),s("span",is,r(z(t.created_at)),1)])]),s("div",us,[s("button",{onClick:H(b=>J(t.id),["stop"]),class:"remove-btn"}," å–æ¶ˆæ”¶è— ",8,cs)])],8,ts)}),128))])):c("",!0)]),s("section",ds,[m.value==="conversations"?(n(),a("div",vs,[h.value?(n(),a("div",ms,[s("div",ks,[k(E,{username:((W=(u=D.value)==null?void 0:u.other_user)==null?void 0:W.username)||"ç”¨æˆ·","avatar-id":(Y=(X=D.value)==null?void 0:X.other_user)==null?void 0:Y.avatar_url,size:"32px"},null,8,["username","avatar-id"]),s("span",ps,r((ee=(Z=D.value)==null?void 0:Z.other_user)==null?void 0:ee.username),1),s("button",{onClick:ve,class:"delete-conversation-btn"}," åˆ é™¤å¯¹è¯ ")]),s("div",{class:"messages-container",ref_key:"messagesContainer",ref:f},[(n(!0),a(V,null,N(re.value,t=>{var _,b;return n(),a("div",{key:t.id,class:R(["message",{"is-sent":t.sender_id===ue.value}])},[k(E,{username:((_=t.sender_profile)==null?void 0:_.username)||"ç”¨æˆ·","avatar-id":(b=t.sender_profile)==null?void 0:b.avatar_url,size:"32px"},null,8,["username","avatar-id"]),s("div",hs,[s("div",fs,r(t.content),1),s("span",bs,r(z(t.created_at)),1)])],2)}),128))],512),s("div",gs,[s("div",ys,[U(s("textarea",{"onUpdate:modelValue":e[5]||(e[5]=t=>y.value=t),placeholder:"è¾“å…¥æ¶ˆæ¯...",rows:"3",onKeydown:ne(H(I,["ctrl"]),["enter"])},null,40,Cs),[[A,y.value]]),s("div",ws,[e[22]||(e[22]=s("span",{class:"input-hint"},"Ctrl + Enter å‘é€",-1)),s("button",{onClick:I,disabled:!y.value.trim(),class:"send-btn"}," å‘é€ ",8,xs)])])])])):(n(),a("div",_s,[...e[21]||(e[21]=[s("p",null,"é€‰æ‹©ä¸€ä¸ªå¯¹è¯å¼€å§‹èŠå¤©",-1)])]))])):c("",!0),m.value==="bookmarks"?(n(),a("div",Ms,[i.value?(n(),a("div",Bs,[s("div",Us,[i.value.target_type==="post"?(n(),a("h3",Vs,r((se=i.value.target_data)==null?void 0:se.title),1)):c("",!0),s("div",Ns,[s("span",Ss,r(i.value.target_type==="post"?"å¸–å­":"è¯„è®º"),1),s("span",Ts,r(i.value.folder_name),1),s("span",Fs,r(z(i.value.created_at)),1)])]),s("div",Ds,r((te=i.value.target_data)==null?void 0:te.content),1),s("div",zs,[e[24]||(e[24]=s("label",null,"å¤‡æ³¨ï¼š",-1)),U(s("textarea",{"onUpdate:modelValue":e[6]||(e[6]=t=>T.value=t),placeholder:"æ·»åŠ å¤‡æ³¨...",onBlur:me},null,544),[[A,T.value]])]),s("div",Ks,[s("button",{onClick:e[7]||(e[7]=t=>J(i.value.id)),class:"remove-btn"}," å–æ¶ˆæ”¶è— "),i.value.target_type==="post"?(n(),a("button",{key:0,onClick:e[8]||(e[8]=t=>ke(i.value.target_id)),class:"view-btn"}," æŸ¥çœ‹åŸå¸– ")):c("",!0)])])):(n(),a("div",$s,[...e[23]||(e[23]=[s("p",null,"é€‰æ‹©ä¸€ä¸ªæ”¶è—æŸ¥çœ‹è¯¦æƒ…",-1)])]))])):c("",!0)])])])]),M.value?(n(),a("div",{key:0,class:"modal-overlay",onClick:e[11]||(e[11]=H(t=>M.value=!1,["self"]))},[s("div",Rs,[e[25]||(e[25]=s("h3",null,"æ–°å»ºæ”¶è—å¤¹",-1)),U(s("input",{"onUpdate:modelValue":e[9]||(e[9]=t=>C.value=t),type:"text",placeholder:"æ”¶è—å¤¹åç§°",onKeydown:ne(O,["enter"])},null,544),[[A,C.value]]),s("div",As,[s("button",{onClick:e[10]||(e[10]=t=>M.value=!1),class:"btn-secondary"}," å–æ¶ˆ "),s("button",{onClick:O,disabled:!C.value.trim(),class:"btn-primary"}," åˆ›å»º ",8,Es)])])])):c("",!0)])}}}),Js=we(Ls,[["__scopeId","data-v-04aa569a"]]);export{Js as default};
//# sourceMappingURL=MessageCenterView-CrJKTdiU.js.map
