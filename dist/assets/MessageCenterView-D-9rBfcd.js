import{d as he,r as d,c as g,i as fe,s as be,w as ge,a,b as s,g as c,l as k,p as R,q as ye,n as A,j as B,t as r,f as U,v as K,F as V,h as N,H as Ce,k as ne,e as H,D as le,o as n,_ as we}from"./index-02sh5J2l.js";import{useAuthStore as xe}from"./auth-DsvB8qh0.js";import{u as Me}from"./messages-DFVbLfQ6.js";import{u as $e}from"./bookmarks-DOOoFvsV.js";import{U as L}from"./UserAvatar-CYysCMLx.js";const Be={class:"message-center"},Ue={class:"header"},Ve={class:"container"},Ne={class:"header-nav"},Se={class:"nav"},Te={key:0,class:"unread-indicator"},De={class:"main"},Fe={class:"container"},ze={class:"message-layout"},Re={class:"sidebar"},Ae={class:"sidebar-tabs"},Ke={key:0,class:"unread-badge"},Le={key:0,class:"conversation-list"},Ee={class:"search-box"},He={key:0,class:"search-results"},Pe=["onClick"],je={key:0,class:"empty-state"},qe=["onClick"],Qe={class:"conversation-info"},Ge={class:"conversation-header"},Ie={class:"username"},Je={class:"time"},Oe={class:"last-message"},We={class:"conversation-meta"},Xe={key:0,class:"unread-count"},Ye={key:1,class:"bookmark-list"},Ze={class:"folder-selector"},es=["value"],ss={key:0,class:"empty-state"},ts=["onClick"],os={class:"bookmark-content"},as={key:0},ns={class:"bookmark-excerpt"},ls={class:"bookmark-meta"},rs={class:"bookmark-type"},is={class:"bookmark-time"},us={class:"bookmark-actions"},cs=["onClick"],ds={class:"content"},vs={key:0,class:"conversation-view"},_s={key:0,class:"empty-conversation"},ms={key:1,class:"chat-container"},ks={class:"chat-header"},ps={class:"chat-username"},hs={class:"message-content"},fs={class:"message-bubble"},bs={class:"message-time"},gs={class:"message-input"},ys={class:"input-wrapper"},Cs=["onKeydown"],ws={class:"input-actions"},xs=["disabled"],Ms={key:1,class:"bookmark-view"},$s={key:0,class:"empty-bookmark"},Bs={key:1,class:"bookmark-detail"},Us={class:"bookmark-header"},Vs={key:0},Ns={class:"bookmark-info"},Ss={class:"bookmark-type"},Ts={class:"bookmark-folder"},Ds={class:"bookmark-time"},Fs={class:"bookmark-content-full"},zs={class:"bookmark-note"},Rs={class:"bookmark-actions"},As={class:"modal-content"},Ks={class:"modal-actions"},Ls=["disabled"],Es=he({__name:"MessageCenterView",setup(Hs){const P=be(),S=xe(),v=Me(),p=$e(),m=d("conversations"),h=d(""),i=d(null),y=d(""),w=d(""),x=d([]),E=d("默认收藏夹"),T=d(""),M=d(!1),C=d(""),f=d(),$=g(()=>{const o=v.conversations;return console.log("conversations computed:",o.length,o),o}),re=g(()=>v.currentMessages),D=g(()=>v.unreadCount),j=g(()=>p.bookmarks),ie=g(()=>p.folders),ue=g(()=>{var o;return((o=S.user)==null?void 0:o.id)||""}),F=g(()=>$.value.find(o=>o.id===h.value));fe(()=>{q()});const q=async()=>{try{if(!S.isAuthenticated){console.warn("用户未登录，跳转到登录页面"),P.push("/login");return}console.log("开始加载消息中心数据..."),await Promise.all([v.fetchConversations().catch(o=>(console.error("获取会话失败:",o),{success:!1})),v.fetchUnreadCount().catch(o=>(console.error("获取未读数量失败:",o),{success:!1})),p.fetchFolders().catch(o=>(console.error("获取收藏夹失败:",o),{success:!1})),Q().catch(o=>(console.error("加载收藏失败:",o),{success:!1}))]),console.log("消息中心数据加载完成")}catch(o){console.error("加载初始数据失败:",o)}},Q=async()=>{await p.fetchBookmarks(E.value)},G=async o=>{console.log("选择对话:",o),h.value=o;const e=await v.fetchMessages(o);console.log("获取消息结果:",e);const l=$.value.find(u=>u.id===o);console.log("找到的对话:",l),l&&l.other_user?(console.log("对话的other_user:",l.other_user),console.log("other_user.id:",l.other_user.id),l.other_user.id?await v.markMessagesAsRead(l.other_user.id):console.warn("other_user.id 为空，跳过标记已读")):console.warn("对话或other_user不存在:",{conversation:l,conversationId:o}),le(()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight)})},I=async()=>{if(!y.value.trim())return;const o=F.value;if(!o||!o.other_user)return;const e=await v.sendMessage(o.other_user.id,y.value.trim());e.success?(y.value="",le(()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight)})):alert("发送失败: "+e.error)},ce=async()=>{if(!w.value.trim()){x.value=[];return}const o=await v.searchUsers(w.value.trim());o.success&&(x.value=o.data)},de=async o=>{x.value=[],w.value="";const e=$.value.find(l=>{var u;return((u=l.other_user)==null?void 0:u.id)===o.id});e?G(e.id):alert("会话功能将在发送第一条消息时自动创建")},ve=async()=>{if(!h.value||!confirm("确定要删除这个对话吗？"))return;const o=await v.deleteConversation(h.value);o.success?h.value="":alert("删除失败: "+o.error)},_e=o=>{i.value=o,T.value=o.note||""},J=async o=>{var l;if(!confirm("确定要取消收藏吗？"))return;const e=await p.removeBookmark(o);e.success?((l=i.value)==null?void 0:l.id)===o&&(i.value=null):alert("取消收藏失败: "+e.error)},me=async()=>{i.value&&await p.updateBookmarkNote(i.value.id,T.value)},O=async()=>{if(!C.value.trim())return;const o=p.createFolder(C.value.trim());o.success?(C.value="",M.value=!1):alert("创建收藏夹失败: "+o.error)},ke=o=>{P.push(`/post/${o}`)},pe=o=>{var l;const e=((l=o.target_data)==null?void 0:l.content)||"";return e.length>100?e.substring(0,100)+"...":e},z=o=>{const e=new Date(o),u=new Date().getTime()-e.getTime();return u<6e4?"刚刚":u<36e5?`${Math.floor(u/6e4)}分钟前`:u<864e5?`${Math.floor(u/36e5)}小时前`:u<6048e5?`${Math.floor(u/864e5)}天前`:e.toLocaleDateString("zh-CN")};return ge(()=>S.user,()=>{S.user&&q()},{immediate:!0}),(o,e)=>{var u,W,X,Y,Z,ee,se,te;const l=ye("RouterLink");return n(),a("div",Be,[s("header",Ue,[s("div",Ve,[s("div",Ne,[k(l,{to:"/",class:"back-link"},{default:R(()=>[...e[12]||(e[12]=[B("← 返回首页",-1)])]),_:1}),s("nav",Se,[k(l,{to:"/profile",class:"nav-link"},{default:R(()=>[...e[13]||(e[13]=[s("i",{class:"bi bi-person"},null,-1),B(" 个人中心 ",-1)])]),_:1}),k(l,{to:"/bookmarks",class:"nav-link"},{default:R(()=>[...e[14]||(e[14]=[s("i",{class:"bi bi-bookmark"},null,-1),B(" 收藏 ",-1)])]),_:1}),k(l,{to:"/messages",class:"nav-link active"},{default:R(()=>[e[15]||(e[15]=s("i",{class:"bi bi-envelope"},null,-1)),e[16]||(e[16]=B(" 消息 ",-1)),D.value>0?(n(),a("span",Te,r(D.value),1)):c("",!0)]),_:1})])]),e[17]||(e[17]=s("h1",null,"消息中心",-1))])]),s("main",De,[s("div",Fe,[s("div",ze,[s("aside",Re,[s("div",Ae,[s("button",{class:A(["tab-btn",{active:m.value==="conversations"}]),onClick:e[0]||(e[0]=t=>m.value="conversations")},[e[18]||(e[18]=B(" 💬 私信 ",-1)),D.value>0?(n(),a("span",Ke,r(D.value),1)):c("",!0)],2),s("button",{class:A(["tab-btn",{active:m.value==="bookmarks"}]),onClick:e[1]||(e[1]=t=>m.value="bookmarks")}," 🔖 收藏 ",2)]),m.value==="conversations"?(n(),a("div",Le,[s("div",Ee,[U(s("input",{"onUpdate:modelValue":e[2]||(e[2]=t=>w.value=t),type:"text",placeholder:"搜索用户...",onInput:ce},null,544),[[K,w.value]]),x.value.length>0?(n(),a("div",He,[(n(!0),a(V,null,N(x.value,t=>(n(),a("div",{key:t.id,class:"search-result-item",onClick:_=>de(t)},[k(L,{username:t.username,"avatar-id":t.avatar_url,size:"32px"},null,8,["username","avatar-id"]),s("span",null,r(t.username),1)],8,Pe))),128))])):c("",!0)]),$.value.length===0?(n(),a("div",je,[...e[19]||(e[19]=[s("p",null,"暂无私信对话",-1)])])):c("",!0),(n(!0),a(V,null,N($.value,t=>{var _,b,oe,ae;return n(),a("div",{key:t.id,class:A(["conversation-item",{active:h.value===t.id}]),onClick:Ps=>G(t.id)},[k(L,{username:((_=t.other_user)==null?void 0:_.username)||"用户","avatar-id":(b=t.other_user)==null?void 0:b.avatar_url,size:"40px"},null,8,["username","avatar-id"]),s("div",Qe,[s("div",Ge,[s("span",Ie,r((oe=t.other_user)==null?void 0:oe.username),1),s("span",Je,r(z(t.last_message_at)),1)]),s("div",Oe,r(((ae=t.last_message)==null?void 0:ae.content)||"暂无消息"),1)]),s("div",We,[t.unread_count>0?(n(),a("span",Xe,r(t.unread_count),1)):c("",!0)])],10,qe)}),128))])):c("",!0),m.value==="bookmarks"?(n(),a("div",Ye,[s("div",Ze,[U(s("select",{"onUpdate:modelValue":e[3]||(e[3]=t=>E.value=t),onChange:Q},[(n(!0),a(V,null,N(ie.value,t=>(n(),a("option",{key:t,value:t},r(t),9,es))),128))],544),[[Ce,E.value]]),s("button",{onClick:e[4]||(e[4]=t=>M.value=!0),class:"create-folder-btn"}," + 新建文件夹 ")]),j.value.length===0?(n(),a("div",ss,[...e[20]||(e[20]=[s("p",null,"暂无收藏内容",-1)])])):c("",!0),(n(!0),a(V,null,N(j.value,t=>{var _;return n(),a("div",{key:t.id,class:"bookmark-item",onClick:b=>_e(t)},[s("div",os,[t.target_type==="post"?(n(),a("h4",as,r((_=t.target_data)==null?void 0:_.title),1)):c("",!0),s("p",ns,r(pe(t)),1),s("div",ls,[s("span",rs,r(t.target_type==="post"?"帖子":"评论"),1),s("span",is,r(z(t.created_at)),1)])]),s("div",us,[s("button",{onClick:H(b=>J(t.id),["stop"]),class:"remove-btn"}," 取消收藏 ",8,cs)])],8,ts)}),128))])):c("",!0)]),s("section",ds,[m.value==="conversations"?(n(),a("div",vs,[h.value?(n(),a("div",ms,[s("div",ks,[k(L,{username:((W=(u=F.value)==null?void 0:u.other_user)==null?void 0:W.username)||"用户","avatar-id":(Y=(X=F.value)==null?void 0:X.other_user)==null?void 0:Y.avatar_url,size:"32px"},null,8,["username","avatar-id"]),s("span",ps,r((ee=(Z=F.value)==null?void 0:Z.other_user)==null?void 0:ee.username),1),s("button",{onClick:ve,class:"delete-conversation-btn"}," 删除对话 ")]),s("div",{class:"messages-container",ref_key:"messagesContainer",ref:f},[(n(!0),a(V,null,N(re.value,t=>{var _,b;return n(),a("div",{key:t.id,class:A(["message",{"is-sent":t.sender_id===ue.value}])},[k(L,{username:((_=t.sender_profile)==null?void 0:_.username)||"用户","avatar-id":(b=t.sender_profile)==null?void 0:b.avatar_url,size:"32px"},null,8,["username","avatar-id"]),s("div",hs,[s("div",fs,r(t.content),1),s("span",bs,r(z(t.created_at)),1)])],2)}),128))],512),s("div",gs,[s("div",ys,[U(s("textarea",{"onUpdate:modelValue":e[5]||(e[5]=t=>y.value=t),placeholder:"输入消息...",rows:"3",onKeydown:ne(H(I,["ctrl"]),["enter"])},null,40,Cs),[[K,y.value]]),s("div",ws,[e[22]||(e[22]=s("span",{class:"input-hint"},"Ctrl + Enter 发送",-1)),s("button",{onClick:I,disabled:!y.value.trim(),class:"send-btn"}," 发送 ",8,xs)])])])])):(n(),a("div",_s,[...e[21]||(e[21]=[s("p",null,"选择一个对话开始聊天",-1)])]))])):c("",!0),m.value==="bookmarks"?(n(),a("div",Ms,[i.value?(n(),a("div",Bs,[s("div",Us,[i.value.target_type==="post"?(n(),a("h3",Vs,r((se=i.value.target_data)==null?void 0:se.title),1)):c("",!0),s("div",Ns,[s("span",Ss,r(i.value.target_type==="post"?"帖子":"评论"),1),s("span",Ts,r(i.value.folder_name),1),s("span",Ds,r(z(i.value.created_at)),1)])]),s("div",Fs,r((te=i.value.target_data)==null?void 0:te.content),1),s("div",zs,[e[24]||(e[24]=s("label",null,"备注：",-1)),U(s("textarea",{"onUpdate:modelValue":e[6]||(e[6]=t=>T.value=t),placeholder:"添加备注...",onBlur:me},null,544),[[K,T.value]])]),s("div",Rs,[s("button",{onClick:e[7]||(e[7]=t=>J(i.value.id)),class:"remove-btn"}," 取消收藏 "),i.value.target_type==="post"?(n(),a("button",{key:0,onClick:e[8]||(e[8]=t=>ke(i.value.target_id)),class:"view-btn"}," 查看原帖 ")):c("",!0)])])):(n(),a("div",$s,[...e[23]||(e[23]=[s("p",null,"选择一个收藏查看详情",-1)])]))])):c("",!0)])])])]),M.value?(n(),a("div",{key:0,class:"modal-overlay",onClick:e[11]||(e[11]=H(t=>M.value=!1,["self"]))},[s("div",As,[e[25]||(e[25]=s("h3",null,"新建收藏夹",-1)),U(s("input",{"onUpdate:modelValue":e[9]||(e[9]=t=>C.value=t),type:"text",placeholder:"收藏夹名称",onKeydown:ne(O,["enter"])},null,544),[[K,C.value]]),s("div",Ks,[s("button",{onClick:e[10]||(e[10]=t=>M.value=!1),class:"btn-secondary"}," 取消 "),s("button",{onClick:O,disabled:!C.value.trim(),class:"btn-primary"}," 创建 ",8,Ls)])])])):c("",!0)])}}}),Js=we(Es,[["__scopeId","data-v-04aa569a"]]);export{Js as default};
//# sourceMappingURL=MessageCenterView-D-9rBfcd.js.map
