import{useAuthStore as H}from"./auth-DsvB8qh0.js";import{u as G}from"./posts-t7kwi12e.js";import{u as q}from"./bookmarks-DOOoFvsV.js";import{U as z}from"./UserAvatar-CYysCMLx.js";import{d as P,r as b,a as u,o as a,b as e,e as x,l as D,j as $,t as r,f as B,v as I,_ as U,c as T,i as E,g,H as J,F as R,h as j,w as K,n as C,m as L,p as O,q as Q}from"./index-02sh5J2l.js";import{u as W}from"./messages-DFVbLfQ6.js";const X={class:"modal-header"},Y={class:"modal-title"},Z={class:"modal-body"},_={class:"mb-3"},ee={class:"form-text"},se={class:"modal-footer"},te=["disabled"],oe={key:0},le={key:1},ne=P({__name:"SendMessageModal",props:{recipient:{}},emits:["close","sent"],setup(o,{emit:k}){const y=o,w=k,f=W(),{sendMessage:h}=f,v=b(""),d=b(!1),c=async()=>{if(v.value.trim()){d.value=!0;try{const i=await h(y.recipient.id,v.value.trim());i.success?(v.value="",w("sent"),w("close")):alert("发送失败："+(i.error||"未知错误"))}catch(i){console.error("发送消息失败:",i),alert("发送失败，请稍后重试")}finally{d.value=!1}}};return(i,l)=>(a(),u("div",{class:"message-modal-overlay",onClick:l[4]||(l[4]=p=>i.$emit("close"))},[e("div",{class:"message-modal",onClick:l[3]||(l[3]=x(()=>{},["stop"]))},[e("div",X,[e("h5",Y,[D(z,{user:o.recipient,size:"sm"},null,8,["user"]),$(" 发送私信给 "+r(o.recipient.username),1)]),e("button",{type:"button",class:"btn-close",onClick:l[0]||(l[0]=p=>i.$emit("close"))})]),e("div",Z,[e("form",{onSubmit:x(c,["prevent"])},[e("div",_,[l[5]||(l[5]=e("label",{for:"message-content",class:"form-label"},"消息内容",-1)),B(e("textarea",{id:"message-content","onUpdate:modelValue":l[1]||(l[1]=p=>v.value=p),class:"form-control",rows:"4",placeholder:"输入你想说的话...",maxlength:"1000",required:""},null,512),[[I,v.value]]),e("div",ee,r(v.value.length)+"/1000 字符 ",1)]),l[8]||(l[8]=e("div",{class:"message-tips"},[e("h6",null,"温馨提示："),e("ul",null,[e("li",null,"请友善交流，尊重他人"),e("li",null,"禁止发送垃圾信息或不当内容"),e("li",null,"消息发送后无法撤回")])],-1)),e("div",se,[e("button",{type:"button",class:"btn btn-secondary",onClick:l[2]||(l[2]=p=>i.$emit("close"))}," 取消 "),e("button",{type:"submit",class:"btn btn-primary",disabled:!v.value.trim()||d.value},[d.value?(a(),u("span",oe,[...l[6]||(l[6]=[e("span",{class:"spinner-border spinner-border-sm me-2"},null,-1),$(" 发送中... ",-1)])])):(a(),u("span",le,[...l[7]||(l[7]=[e("i",{class:"bi bi-send me-2"},null,-1),$(" 发送消息 ",-1)])]))],8,te)])],32)])])]))}}),ae=U(ne,[["__scopeId","data-v-f1e529ae"]]),ie={class:"modal-header"},re={class:"modal-body"},ue={class:"mb-3"},de={class:"folder-input-group"},ce=["value"],me={key:0,class:"mb-3"},ve={class:"form-text"},pe={class:"mb-3"},be={class:"form-text"},ke={class:"post-preview"},fe={class:"preview-content"},ge={class:"modal-footer"},$e=["disabled"],ye={key:0},we={key:1},he=P({__name:"BookmarkModal",props:{post:{}},emits:["close","bookmarked"],setup(o,{emit:k}){const y=o,w=k,f=q(),{addBookmark:h,fetchFolders:v,createFolder:d}=f,c=b(""),i=b(""),l=b(""),p=b(!1),M=b([]),S=T(()=>c.value==="__new__"?i.value.trim()!=="":c.value!==""),V=(n,s)=>n.length<=s?n:n.substring(0,s)+"...",F=async()=>{if(S.value){p.value=!0;try{let n=c.value;if(c.value==="__new__"){n=i.value.trim(),console.log("创建新收藏夹:",n);const t=await d(n);if(!t.success){console.error("创建收藏夹失败:",t.error),alert("创建收藏夹失败："+(t.error||"未知错误"));return}console.log("创建收藏夹成功")}console.log("开始收藏，文件夹:",n,"帖子ID:",y.post.id);const s=await h("post",y.post.id,n,l.value.trim());console.log("收藏结果:",s),s.success?(w("bookmarked"),w("close")):(console.error("收藏失败:",s.error),alert("收藏失败："+(s.error||"未知错误")))}catch(n){console.error("收藏异常:",n),alert("收藏失败，请稍后重试")}finally{p.value=!1}}},N=async()=>{try{await v(),M.value=f.folders}catch(n){console.error("加载收藏夹失败:",n)}};return E(()=>{N()}),(n,s)=>(a(),u("div",{class:"bookmark-modal-overlay",onClick:s[6]||(s[6]=t=>n.$emit("close"))},[e("div",{class:"bookmark-modal",onClick:s[5]||(s[5]=x(()=>{},["stop"]))},[e("div",ie,[s[7]||(s[7]=e("h5",{class:"modal-title"},[e("i",{class:"bi bi-bookmark-star"}),$(" 收藏帖子 ")],-1)),e("button",{type:"button",class:"btn-close",onClick:s[0]||(s[0]=t=>n.$emit("close"))})]),e("div",re,[e("form",{onSubmit:x(F,["prevent"])},[e("div",ue,[s[10]||(s[10]=e("label",{for:"folder-name",class:"form-label"},"收藏夹",-1)),e("div",de,[B(e("select",{id:"folder-name","onUpdate:modelValue":s[1]||(s[1]=t=>c.value=t),class:"form-select",required:""},[s[8]||(s[8]=e("option",{value:""},"选择收藏夹...",-1)),(a(!0),u(R,null,j(M.value,t=>(a(),u("option",{key:t,value:t},r(t),9,ce))),128)),s[9]||(s[9]=e("option",{value:"__new__"},"+ 创建新收藏夹",-1))],512),[[J,c.value]])])]),c.value==="__new__"?(a(),u("div",me,[s[11]||(s[11]=e("label",{for:"new-folder-name",class:"form-label"},"新收藏夹名称",-1)),B(e("input",{id:"new-folder-name","onUpdate:modelValue":s[2]||(s[2]=t=>i.value=t),type:"text",class:"form-control",placeholder:"输入收藏夹名称...",maxlength:"20",required:""},null,512),[[I,i.value]]),e("div",ve,r(i.value.length)+"/20 字符 ",1)])):g("",!0),e("div",pe,[s[12]||(s[12]=e("label",{for:"bookmark-note",class:"form-label"},"备注（可选）",-1)),B(e("textarea",{id:"bookmark-note","onUpdate:modelValue":s[3]||(s[3]=t=>l.value=t),class:"form-control",rows:"3",placeholder:"添加备注...",maxlength:"200"},null,512),[[I,l.value]]),e("div",be,r(l.value.length)+"/200 字符 ",1)]),e("div",ke,[s[13]||(s[13]=e("h6",null,"帖子预览",-1)),e("div",fe,[e("h6",null,r(o.post.title),1),e("p",null,r(V(o.post.content,100)),1)])]),e("div",ge,[e("button",{type:"button",class:"btn btn-secondary",onClick:s[4]||(s[4]=t=>n.$emit("close"))}," 取消 "),e("button",{type:"submit",class:"btn btn-primary",disabled:!S.value||p.value},[p.value?(a(),u("span",ye,[...s[14]||(s[14]=[e("span",{class:"spinner-border spinner-border-sm me-2"},null,-1),$(" 收藏中... ",-1)])])):(a(),u("span",we,[...s[15]||(s[15]=[e("i",{class:"bi bi-bookmark-plus me-2"},null,-1),$(" 确认收藏 ",-1)])]))],8,$e)])],32)])])]))}}),Ce=U(he,[["__scopeId","data-v-3f37483c"]]),Me={class:"post-header"},Se={class:"user-info"},Be={class:"user-details"},xe={class:"level-badge"},Ve={class:"post-time"},Fe={class:"post-actions"},Ne={key:0,class:"pinned-indicator"},De={class:"action-buttons"},Ie={class:"post-content"},Te={class:"post-title"},Pe={class:"post-excerpt"},Ue={key:0,class:"post-tags"},Ae={class:"post-footer"},Le={class:"interaction-stats"},qe={class:"view-count"},ze=P({__name:"PostCard",props:{post:{}},emits:["like","comment"],setup(o){const k=o,y=H(),w=G(),f=q(),h=b(!1),v=b(!1),d=b(!1),c=T(()=>y.isAuthenticated),i=T(()=>{var s;return((s=y.user)==null?void 0:s.id)===k.post.user_id});E(async()=>{c.value&&(d.value=await f.checkIsBookmarked("post",k.post.id))}),K(c,async s=>{s?d.value=await f.checkIsBookmarked("post",k.post.id):d.value=!1});const l=()=>{h.value=!0},p=()=>{console.log("私信发送成功")},M=()=>{v.value=!0},S=async()=>{d.value=await f.checkIsBookmarked("post",k.post.id),console.log("帖子收藏成功，状态已更新")},V=async()=>{if(!confirm("确定要删除这个帖子吗？此操作不可恢复。"))return;const s=await w.deletePost(k.post.id);s.success?console.log("帖子删除成功"):(console.error("删除帖子失败:",s.error),alert("删除失败: "+s.error))},F=s=>s>=10?"level-10-plus":s>=7?"level-7-9":s>=4?"level-4-6":"level-1-3",N=s=>{const t=new Date(s),m=new Date().getTime()-t.getTime();return m<6e4?"刚刚":m<36e5?`${Math.floor(m/6e4)}分钟前`:m<864e5?`${Math.floor(m/36e5)}小时前`:m<6048e5?`${Math.floor(m/864e5)}天前`:t.toLocaleDateString("zh-CN")},n=s=>{const t=s.replace(/[#*_~`]/g,"").replace(/\n/g," ");return t.length>100?t.substring(0,100)+"...":t};return(s,t)=>{const A=Q("RouterLink");return a(),u("article",{class:C(["post-card",{"post-pinned":o.post.is_pinned}])},[e("div",Me,[e("div",Se,[D(z,{username:o.post.profiles.username,"avatar-id":o.post.profiles.avatar_url,size:"40px"},null,8,["username","avatar-id"]),e("div",Be,[e("span",{class:C(["username",F(o.post.profiles.level)])},[$(r(o.post.profiles.username)+" ",1),e("span",xe,"Lv."+r(o.post.profiles.level),1)],2),e("span",Ve,r(N(o.post.created_at)),1)])]),e("div",Fe,[o.post.is_pinned?(a(),u("div",Ne,[...t[4]||(t[4]=[e("span",null,"📌 置顶",-1)])])):g("",!0),e("div",De,[c.value&&!i.value?(a(),u("button",{key:0,class:"action-btn message-btn",onClick:l,title:"发送私信"},[...t[5]||(t[5]=[e("i",{class:"bi bi-envelope"},null,-1),e("span",null,"私信",-1)])])):g("",!0),c.value?(a(),u("button",{key:1,class:C(["action-btn bookmark-btn",{active:d.value}]),onClick:M,title:"收藏帖子"},[e("i",{class:C(["bi",d.value?"bi-bookmark-fill":"bi-bookmark"])},null,2),e("span",null,r(d.value?"已收藏":"收藏"),1)],2)):g("",!0),i.value?(a(),u("button",{key:2,class:"action-btn delete-btn",onClick:V,title:"删除帖子"},[...t[6]||(t[6]=[e("i",{class:"bi bi-trash"},null,-1),e("span",null,"删除",-1)])])):g("",!0)])])]),e("div",Ie,[e("h3",Te,[D(A,{to:`/post/${o.post.id}`,class:"title-link"},{default:O(()=>[$(r(o.post.title),1)]),_:1},8,["to"])]),e("p",Pe,r(n(o.post.content)),1),o.post.tags&&o.post.tags.length>0?(a(),u("div",Ue,[(a(!0),u(R,null,j(o.post.tags.slice(0,3),m=>(a(),u("span",{key:m,class:"tag"}," #"+r(m),1))),128))])):g("",!0)]),e("div",Ae,[e("div",Le,[e("button",{class:C(["interaction-btn",{active:o.post.user_has_liked}]),onClick:t[0]||(t[0]=m=>s.$emit("like",o.post.id))},[e("i",{class:C(["bi",o.post.user_has_liked?"bi-heart-fill":"bi-heart"])},null,2),e("span",null,"点赞 "+r(o.post.like_count),1)],2),e("button",{class:"interaction-btn",onClick:t[1]||(t[1]=m=>s.$emit("comment",o.post.id))},[t[7]||(t[7]=e("i",{class:"bi bi-chat"},null,-1)),e("span",null,"评论 "+r(o.post.comment_count),1)]),e("span",qe,[t[8]||(t[8]=e("i",{class:"bi bi-eye"},null,-1)),e("span",null,"浏览 "+r(o.post.view_count),1)])])]),h.value?(a(),L(ae,{key:0,recipient:{id:o.post.user_id,username:o.post.profiles.username,avatar_url:o.post.profiles.avatar_url,level:o.post.profiles.level},onClose:t[2]||(t[2]=m=>h.value=!1),onSent:p},null,8,["recipient"])):g("",!0),v.value?(a(),L(Ce,{key:1,post:{id:o.post.id,title:o.post.title,content:o.post.content},onClose:t[3]||(t[3]=m=>v.value=!1),onBookmarked:S},null,8,["post"])):g("",!0)],2)}}}),Ke=U(ze,[["__scopeId","data-v-39ce9635"]]);export{Ke as P};
//# sourceMappingURL=PostCard-Dk0tpnu1.js.map
