import{d as R,i as y,c as l,h as a,a as e,k as P,n as S,f as h,t as r,b as f,_ as z,D as E,r as I,l as G,y as J,q as T,s as K,F as M,g as V,j as O,v as Q,x as W,p as X,u as Y}from"./index-DvT1nwGZ.js";import{useAuthStore as U}from"./auth-hIVPxf3j.js";import{u as q}from"./posts-CXiqjE5Q.js";import{U as Z}from"./UserAvatar-xuan3Pxw.js";const ee={class:"comment-item"},te={class:"comment-header"},se={class:"comment-author"},oe={class:"author-info"},ne={class:"level-badge"},ae={class:"comment-time"},le={class:"comment-actions"},re={key:0,class:"pinned-badge"},ie={class:"comment-content"},ce={class:"comment-actions"},ue=R({__name:"CommentItem",props:{comment:{},postId:{},isPostAuthor:{type:Boolean}},emits:["like","pin","refresh"],setup(i,{emit:x}){const _=i,g=U();q();const p=x,b=y(()=>{var n;return((n=g.user)==null?void 0:n.id)===_.comment.user_id}),m=y(()=>{var v;const n=((v=g.profile)==null?void 0:v.level)||1,c=_.isPostAuthor||!1;return n>=10||c}),C=async()=>{if(!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚"))return;const n=await postStore.deleteComment(_.comment.id);n.success?(console.log("è¯„è®ºåˆ é™¤æˆåŠŸ"),p("refresh")):(console.error("åˆ é™¤è¯„è®ºå¤±è´¥:",n.error),alert("åˆ é™¤å¤±è´¥: "+n.error))},o=async()=>{var c;if(!_.postId){console.error("ç¼ºå°‘postIdï¼Œæ— æ³•æ‰§è¡Œç½®é¡¶æ“ä½œ");return}const n=await postStore.toggleCommentPin(_.comment.id,_.postId);n.success?(console.log("è¯„è®ºç½®é¡¶çŠ¶æ€åˆ‡æ¢æˆåŠŸ:",(c=n.data)!=null&&c.is_pinned?"å·²ç½®é¡¶":"å·²å–æ¶ˆç½®é¡¶"),p("refresh")):(console.error("åˆ‡æ¢ç½®é¡¶çŠ¶æ€å¤±è´¥:",n.error),alert("æ“ä½œå¤±è´¥: "+n.error.message))},k=n=>n>=10?"level-10-plus":n>=7?"level-7-9":n>=4?"level-4-6":"level-1-3",D=n=>{const c=new Date(n),u=new Date().getTime()-c.getTime();return u<6e4?"åˆšåˆš":u<36e5?`${Math.floor(u/6e4)}åˆ†é’Ÿå‰`:u<864e5?`${Math.floor(u/36e5)}å°æ—¶å‰`:u<6048e5?`${Math.floor(u/864e5)}å¤©å‰`:c.toLocaleDateString("zh-CN")};return(n,c)=>{var v,u,w,$,L;return a(),l("div",ee,[e("div",te,[e("div",se,[P(Z,{username:((v=i.comment.profiles)==null?void 0:v.username)||"åŒ¿åç”¨æˆ·","avatar-id":(u=i.comment.profiles)==null?void 0:u.avatar_url,size:"32px"},null,8,["username","avatar-id"]),e("div",oe,[e("span",{class:S(["username",k(((w=i.comment.profiles)==null?void 0:w.level)||1)])},[h(r((($=i.comment.profiles)==null?void 0:$.username)||"åŒ¿åç”¨æˆ·")+" ",1),e("span",ne,"Lv."+r(((L=i.comment.profiles)==null?void 0:L.level)||1),1)],2),e("span",ae,r(D(i.comment.created_at)),1)])]),e("div",le,[i.comment.is_pinned?(a(),l("div",re," ðŸ“Œ ç½®é¡¶ ")):f("",!0),m.value&&!i.comment.is_pinned?(a(),l("button",{key:1,class:"pin-btn",onClick:o,title:"ç½®é¡¶è¯„è®º"}," ðŸ“Œ ")):f("",!0),m.value&&i.comment.is_pinned?(a(),l("button",{key:2,class:"unpin-btn",onClick:o,title:"å–æ¶ˆç½®é¡¶"}," ðŸ“ ")):f("",!0),b.value?(a(),l("button",{key:3,class:"delete-btn",onClick:C,title:"åˆ é™¤è¯„è®º"}," ðŸ—‘ï¸ ")):f("",!0)])]),e("div",ie,[e("p",null,r(i.comment.content),1)]),e("div",ce,[e("button",{class:S(["action-btn",{active:i.comment.user_has_liked}]),onClick:c[0]||(c[0]=B=>n.$emit("like",i.comment.id))}," ðŸ‘ "+r(i.comment.like_count),3),c[1]||(c[1]=e("button",{class:"action-btn"}," ðŸ’¬ å›žå¤ ",-1))])])}}}),de=z(ue,[["__scopeId","data-v-d590e1ec"]]),me={class:"post-detail"},ve={class:"header"},_e={class:"container"},pe={class:"title"},he={class:"main"},fe={class:"container"},ge={key:0,class:"loading"},ke={key:1,class:"post-content"},ye={class:"post-article"},be={class:"post-header"},Ce={class:"author-info"},we=["src","alt"],$e={class:"author-details"},Le={class:"level-badge"},Ie={class:"post-time"},Pe={class:"post-stats"},Se={class:"stat"},xe={class:"stat"},De={class:"stat"},Ae={class:"post-body"},Te=["innerHTML"],Me={key:0,class:"post-images"},Ve={class:"images-grid"},Be=["src","alt","onClick"],Ne={key:1,class:"post-tags"},Re={class:"post-actions"},ze={class:"comments-section"},Ue={key:0,class:"comment-input"},qe={class:"comment-actions"},Fe={class:"char-count"},He=["disabled"],je={key:1,class:"comment-login-prompt"},Ee={key:2,class:"comments-list"},Ge={key:3,class:"no-comments"},Je={key:2,class:"error"},Ke=R({__name:"PostDetailView",setup(i){const x=E(),_=W(),g=U();q();const p=x.params.id,b=I(!0),m=I(""),C=I(),o=y(()=>postStore.currentPost),k=y(()=>g.isAuthenticated),D=y(()=>{var s,t;return((s=g.user)==null?void 0:s.id)===((t=o.value)==null?void 0:t.user_id)}),n=I([]);G(async()=>{await c(),await v()});const c=async()=>{try{await postStore.fetchPostById(p)}catch(s){console.error("åŠ è½½å¸–å­å¤±è´¥:",s)}finally{b.value=!1}},v=async()=>{try{const{data:s,error:t}=await J.from("comments").select(`
        *,
        profiles:user_id (username, avatar_url, level)
      `).eq("post_id",p).order("is_pinned",{ascending:!1}).order("created_at",{ascending:!0});if(t)throw t;n.value=s||[]}catch(s){console.error("åŠ è½½è¯„è®ºå¤±è´¥:",s),n.value=[]}},u=async()=>{if(!k.value){_.push("/login");return}try{await postStore.toggleLike(p)}catch(s){console.error("ç‚¹èµžå¤±è´¥:",s)}},w=()=>{var s;if(!k.value){_.push("/login");return}(s=C.value)==null||s.focus()},$=async()=>{var s;if(m.value.trim())try{const t=await postStore.createComment(p,m.value.trim());t.success?(m.value="",await v()):alert(((s=t.error)==null?void 0:s.message)||"è¯„è®ºå‘å¸ƒå¤±è´¥")}catch(t){console.error("æäº¤è¯„è®ºå¤±è´¥:",t),alert("è¯„è®ºå‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•")}},L=s=>{console.log("ç‚¹èµžè¯„è®º:",s)},B=s=>s>=10?"level-10-plus":s>=7?"level-7-9":s>=4?"level-4-6":"level-1-3",F=s=>new Date(s).toLocaleString("zh-CN"),H=s=>s.replace(/\n/g,"<br>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>"),j=s=>{window.open(s,"_blank")};return(s,t)=>{var N;const A=K("RouterLink");return a(),l("div",me,[e("header",ve,[e("div",_e,[P(A,{to:"/",class:"back-link"},{default:T(()=>[...t[1]||(t[1]=[h("â† è¿”å›žé¦–é¡µ",-1)])]),_:1}),e("h1",pe,r((N=o.value)==null?void 0:N.title),1)])]),e("main",he,[e("div",fe,[b.value?(a(),l("div",ge,"åŠ è½½ä¸­...")):o.value?(a(),l("div",ke,[e("article",ye,[e("div",be,[e("div",Ce,[e("img",{src:o.value.profiles.avatar_url||"/default-avatar.png",alt:o.value.profiles.username,class:"avatar"},null,8,we),e("div",$e,[e("span",{class:S(["username",B(o.value.profiles.level)])},[h(r(o.value.profiles.username)+" ",1),e("span",Le,"Lv."+r(o.value.profiles.level),1)],2),e("span",Ie,r(F(o.value.created_at)),1)])]),e("div",Pe,[e("span",Se,"ðŸ‘ï¸ "+r(o.value.view_count)+" æµè§ˆ",1),e("span",xe,"ðŸ‘ "+r(o.value.like_count)+" ç‚¹èµž",1),e("span",De,"ðŸ’¬ "+r(o.value.comment_count)+" è¯„è®º",1)])]),e("div",Ae,[e("div",{class:"content",innerHTML:H(o.value.content)},null,8,Te),o.value.post_images&&o.value.post_images.length>0?(a(),l("div",Me,[e("h4",null,"å¸–å­å›¾ç‰‡ ("+r(o.value.post_images.length)+")",1),e("div",Ve,[(a(!0),l(M,null,V(o.value.post_images,d=>(a(),l("div",{key:d.id,class:"image-item"},[e("img",{src:d.image_url,alt:d.alt_text||"å¸–å­å›¾ç‰‡",onClick:Oe=>j(d.image_url),class:"post-image"},null,8,Be)]))),128))])])):f("",!0),o.value.tags&&o.value.tags.length>0?(a(),l("div",Ne,[(a(!0),l(M,null,V(o.value.tags,d=>(a(),l("span",{key:d,class:"tag"}," #"+r(d),1))),128))])):f("",!0)]),e("div",Re,[e("button",{class:S(["action-btn",{active:o.value.user_has_liked}]),onClick:u}," ðŸ‘ "+r(o.value.like_count),3),e("button",{class:"action-btn",onClick:w}," ðŸ’¬ è¯„è®º "),t[2]||(t[2]=e("button",{class:"action-btn"}," ðŸ“Œ æ”¶è— ",-1))])]),e("section",ze,[e("h3",null,"è¯„è®º ("+r(o.value.comment_count)+")",1),k.value?(a(),l("div",Ue,[O(e("textarea",{ref_key:"commentInput",ref:C,"onUpdate:modelValue":t[0]||(t[0]=d=>m.value=d),placeholder:"å†™ä¸‹ä½ çš„è¯„è®º...",rows:"3",maxlength:"1000"},null,512),[[Q,m.value]]),e("div",qe,[e("span",Fe,r(m.value.length)+"/1000",1),e("button",{onClick:$,disabled:!m.value.trim(),class:"submit-btn"}," å‘å¸ƒè¯„è®º ",8,He)])])):(a(),l("div",je,[e("p",null,[t[4]||(t[4]=h("è¯· ",-1)),P(A,{to:"/login"},{default:T(()=>[...t[3]||(t[3]=[h("ç™»å½•",-1)])]),_:1}),t[5]||(t[5]=h(" åŽå‘è¡¨è¯„è®º",-1))])])),n.value.length>0?(a(),l("div",Ee,[(a(!0),l(M,null,V(n.value,d=>(a(),X(de,{key:d.id,comment:d,"post-id":Y(p),"is-post-author":D.value,onLike:L,onRefresh:v},null,8,["comment","post-id","is-post-author"]))),128))])):(a(),l("div",Ge,[...t[6]||(t[6]=[e("p",null,"æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼",-1)])]))])])):(a(),l("div",Je,[t[8]||(t[8]=e("p",null,"å¸–å­ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤",-1)),P(A,{to:"/",class:"back-link"},{default:T(()=>[...t[7]||(t[7]=[h("è¿”å›žé¦–é¡µ",-1)])]),_:1})]))])])])}}}),Ze=z(Ke,[["__scopeId","data-v-4aea8d01"]]);export{Ze as default};
//# sourceMappingURL=PostDetailView-BQ2iEe4Z.js.map
