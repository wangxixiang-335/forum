const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-02sh5J2l.js","assets/index-DZoKQPTh.css"])))=>i.map(i=>d[i]);
import{d as M,r as y,i as z,a as i,b as s,F,h as P,D as ee,o as r,n as U,E as V,t as u,_ as J,c as g,C as oe,G as B,g as L,l as b,p as E,q as se,j as x,e as te,m as ae}from"./index-02sh5J2l.js";import{useAuthStore as le}from"./auth-DsvB8qh0.js";import{u as ne}from"./posts-t7kwi12e.js";import{P as re}from"./PostCard-Dk0tpnu1.js";import{U as ie}from"./UserAvatar-CYysCMLx.js";import"./bookmarks-DOOoFvsV.js";import"./messages-DFVbLfQ6.js";const ce={class:"avatar-selector"},ue={class:"selector-header"},de={class:"avatar-grid"},ve=["onClick"],pe={class:"avatar-icon"},fe={class:"avatar-name"},me={class:"avatar-actions"},_e=["disabled"],ge=M({__name:"AvatarSelector",emits:["close","select"],setup(q,{emit:w}){const c=w,f=y(""),v=y(""),k=[{id:"cat",name:"猫咪",icon:"🐱",color:"#FF6B6B"},{id:"dog",name:"小狗",icon:"🐶",color:"#4ECDC4"},{id:"bear",name:"小熊",icon:"🐻",color:"#45B7D1"},{id:"rabbit",name:"兔子",icon:"🐰",color:"#96CEB4"},{id:"panda",name:"熊猫",icon:"🐼",color:"#FFEAA7"},{id:"fox",name:"狐狸",icon:"🦊",color:"#DDA0DD"},{id:"lion",name:"狮子",icon:"🦁",color:"#FFA07A"},{id:"monkey",name:"猴子",icon:"🐵",color:"#98D8C8"},{id:"pig",name:"小猪",icon:"🐷",color:"#FFB6C1"},{id:"cow",name:"奶牛",icon:"🐮",color:"#87CEEB"},{id:"tiger",name:"老虎",icon:"🐯",color:"#FFD700"},{id:"elephant",name:"大象",icon:"🐘",color:"#F0E68C"},{id:"giraffe",name:"长颈鹿",icon:"🦒",color:"#FFA500"},{id:"penguin",name:"企鹅",icon:"🐧",color:"#B0E0E6"},{id:"owl",name:"猫头鹰",icon:"🦉",color:"#D8BFD8"},{id:"turtle",name:"乌龟",icon:"🐢",color:"#90EE90"}];z(()=>{const n=localStorage.getItem("userAvatar");n&&(f.value=n,v.value=n)});const m=n=>{f.value=n.id},p=()=>{if(!f.value)return;const n=k.find(t=>t.id===f.value);n&&(c("select",n),ee(()=>{c("close")}))};return(n,t)=>(r(),i("div",ce,[s("div",ue,[t[2]||(t[2]=s("h3",null,"选择头像",-1)),s("button",{onClick:t[0]||(t[0]=d=>n.$emit("close")),class:"close-btn",title:"关闭"}," ✕ ")]),s("div",de,[(r(),i(F,null,P(k,d=>s("div",{key:d.id,class:U(["avatar-option",{active:f.value===d.id}]),onClick:I=>m(d)},[s("div",{class:"avatar-preview",style:V({backgroundColor:d.color})},[s("span",pe,u(d.icon),1)],4),s("span",fe,u(d.name),1)],10,ve)),64))]),s("div",me,[s("button",{onClick:p,class:"btn-primary",disabled:!f.value}," 保存头像 ",8,_e),s("button",{onClick:t[1]||(t[1]=d=>n.$emit("close")),class:"btn-secondary"}," 取消 ")])]))}}),he=J(ge,[["__scopeId","data-v-d2a5bd20"]]),be={class:"profile"},ke={class:"header"},xe={class:"container"},ye={class:"header-nav"},Ce={key:0,class:"nav"},Ee={class:"main"},we={class:"container"},De={key:0,class:"loading"},Ie={key:1,class:"profile-content"},Ae={class:"profile-card"},Le={class:"profile-header"},Fe={key:0,class:"avatar-edit-hint"},Pe={key:1,class:"avatar-locked"},Se={class:"profile-info"},$e={class:"level-badge"},Ne={class:"member-since"},Be={class:"experience-section"},Me={class:"exp-info"},ze={class:"exp-progress"},Ue={class:"exp-text"},Ve={class:"privileges-section"},Je={class:"privileges-list"},qe={class:"privilege-icon"},Oe={class:"privilege-name"},Re={class:"user-posts"},je={key:0,class:"posts-list"},Xe={key:1,class:"no-posts"},Te={key:2,class:"error"},Ze={class:"modal-content"},Ge=M({__name:"ProfileView",setup(q){const w=oe(),c=le(),f=ne(),v=g(()=>!!w.params.id),k=g(()=>w.params.id),m=y(!0),p=y([]),n=y(!1),t=g(()=>v.value?d.value:c.profile),d=y(null),I=e=>{const o=[0,50,150,300,500,800,1200,1800,2500,3500,5e3,7e3,1e4];if(e<=1)return 0;if(e>=o.length){const a=o[o.length-1],l=e-o.length+1;return a+l*2e3}return o[e-1]},D=g(()=>{if(!t.value)return 50;const e=t.value.level;return I(e+1)}),S=g(()=>{if(!t.value)return 0;const e=t.value.level;return I(e)}),A=g(()=>{if(!t.value)return 0;const e=t.value.experience_points||0,o=S.value,a=D.value;if(console.log("计算经验进度:",{currentExp:e,currentLevelReq:o,nextLevelReq:a,level:t.value.level}),e>=a)return 100;const l=a-e,_=e+l;if(console.log("进度计算:",{expNeededForNext:l,totalExpForProgress:_}),_<=0)return 0;const h=Math.floor(e/_*100);return console.log("最终进度:",h),Math.max(0,Math.min(100,h))}),O=e=>{const o=["新手","初级","中级","高级","资深","专家","大师","宗师","传奇","史诗","神话","至尊"];return e<=1?"新手":e>o.length?"至尊":o[e-1]},$=g(()=>{var o;return(((o=t.value)==null?void 0:o.level)||1)>=3}),R=g(()=>{var a;const e=((a=t.value)==null?void 0:a.level)||1,o=[];return o.push({id:"basic",name:"发帖、评论、点赞",icon:"📝"}),e>=3&&o.push({id:"avatar",name:"自定义头像",icon:"🖼️"}),e>=5&&o.push({id:"signature",name:"个性签名",icon:"✍️"}),e>=7&&o.push({id:"color",name:"个性化色彩",icon:"🎨"}),e>=10&&o.push({id:"mod",name:"评论置顶权限",icon:"⭐"}),o});z(async()=>{await j()});const j=async()=>{console.log("开始加载用户数据..."),m.value=!0;try{if(v.value)console.log("加载其他用户资料，ID:",k.value),await Y();else{if(!c.user){console.warn("用户未登录，无法加载个人资料"),m.value=!1;return}if(console.log("用户已登录，ID:",c.user.id),c.profile)console.log("用户资料已存在:",c.profile);else{console.log("用户资料为空，尝试获取...");try{console.log("调用fetchProfile..."),await c.fetchProfile(),console.log("fetchProfile完成")}catch(e){console.warn("加载用户资料失败，使用默认值:",e)}}console.log("开始加载用户帖子..."),await X(),console.log("用户帖子加载完成")}}catch(e){console.error("加载用户数据失败:",e)}finally{console.log("设置loading为false"),m.value=!1}},X=async()=>{if(!c.user){console.warn("用户未登录，无法加载用户帖子"),p.value=[];return}try{const e=await f.fetchUserPosts(c.user.id);e.success?p.value=e.data||[]:(console.error("加载用户帖子失败:",e.error),p.value=[])}catch(e){console.error("加载用户帖子失败:",e),p.value=[]}},T=e=>{console.log("点赞帖子:",e)},Z=e=>{console.log("评论帖子:",e)},G=async e=>{var o;try{n.value=!1,localStorage.setItem("userAvatar",e.id),t.value&&(t.value.avatar_url=e.id);const a="https://bkintupjzbcjiqvzricz.supabase.co",l="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!a||!l||a.includes("default.supabase.co")||l.includes("default")){console.log("开发模式：头像已更新到本地状态");return}const{supabase:_}=await B(async()=>{const{supabase:C}=await import("./index-02sh5J2l.js").then(H=>H.M);return{supabase:C}},__vite__mapDeps([0,1])),{error:h}=await _.from("profiles").update({avatar_url:e.id,updated_at:new Date().toISOString()}).eq("id",(o=c.user)==null?void 0:o.id);if(h){console.error("更新头像失败:",h);const C=localStorage.getItem("userAvatar");t.value&&(t.value.avatar_url=C||null)}else console.log("头像更新成功")}catch(a){console.error("更新头像失败:",a)}},Y=async()=>{try{const{supabase:e}=await B(async()=>{const{supabase:h}=await import("./index-02sh5J2l.js").then(C=>C.M);return{supabase:h}},__vite__mapDeps([0,1])),{data:o,error:a}=await e.from("profiles").select("*").eq("id",k.value).single();if(a){console.error("获取用户资料失败:",a),m.value=!1;return}d.value=o,console.log("其他用户资料加载成功:",o);const{data:l,error:_}=await e.from("posts").select("*").eq("user_id",k.value).order("created_at",{ascending:!1});_?console.error("获取用户帖子失败:",_):p.value=l||[]}catch(e){console.error("加载其他用户数据失败:",e)}finally{m.value=!1}},W=e=>e>=10?"level-10-plus":e>=7?"level-7-9":e>=4?"level-4-6":"level-1-3",N=()=>{t.value&&(console.log("Profile data:",t.value),console.log("Experience points:",t.value.experience_points),console.log("Level:",t.value.level),console.log("Current level exp:",S.value),console.log("Next level exp:",D.value),console.log("Progress:",A.value))},K=async()=>{await c.updateExperience(10),N()},Q=e=>e?new Date(e).toLocaleDateString("zh-CN"):"未知时间";return(e,o)=>{const a=se("RouterLink");return r(),i("div",be,[s("header",ke,[s("div",xe,[s("div",ye,[b(a,{to:"/",class:"back-link"},{default:E(()=>[...o[3]||(o[3]=[x("← 返回首页",-1)])]),_:1}),v.value?L("",!0):(r(),i("nav",Ce,[b(a,{to:"/profile",class:"nav-link active"},{default:E(()=>[...o[4]||(o[4]=[x("个人中心",-1)])]),_:1}),b(a,{to:"/bookmarks",class:"nav-link"},{default:E(()=>[...o[5]||(o[5]=[s("i",{class:"bi bi-bookmark"},null,-1),x(" 收藏 ",-1)])]),_:1}),b(a,{to:"/messages",class:"nav-link"},{default:E(()=>[...o[6]||(o[6]=[s("i",{class:"bi bi-envelope"},null,-1),x(" 消息 ",-1)])]),_:1})]))]),s("h1",null,u(v.value?"用户资料":"个人中心"),1)])]),s("main",Ee,[s("div",we,[m.value?(r(),i("div",De,"加载中...")):t.value?(r(),i("div",Ie,[s("div",Ae,[s("div",Le,[s("div",{class:"avatar-container",onClick:o[0]||(o[0]=l=>!v.value&&$.value&&(n.value=!0))},[b(ie,{username:t.value.username,"avatar-id":t.value.avatar_url,size:"80px"},null,8,["username","avatar-id"]),!v.value&&$.value?(r(),i("div",Fe,[...o[7]||(o[7]=[s("span",null,"点击更换",-1)])])):v.value?L("",!0):(r(),i("div",Pe,[...o[8]||(o[8]=[s("span",null,"Lv.3 解锁",-1)])]))]),s("div",Se,[s("h2",{class:U(["username",W(t.value.level)])},[x(u(t.value.username)+" ",1),s("span",$e,"Lv."+u(t.value.level)+" "+u(O(t.value.level)),1)],2),s("p",Ne," 注册时间："+u(Q(t.value.created_at)),1)])]),s("div",Be,[s("div",Me,[s("span",null,"经验值："+u(t.value.experience_points||0),1),s("span",null,"下一等级："+u(D.value-(t.value.experience_points||0)>0?D.value-(t.value.experience_points||0)+" EXP":"已满"),1),s("button",{onClick:N,class:"debug-btn",title:"调试经验值"}," 调试 ")]),s("div",ze,[s("div",{class:"exp-bar",style:V({width:A.value+"%"})},null,4),s("span",Ue,u(A.value)+"%",1)]),s("div",{class:"exp-debug"},[s("button",{onClick:K,class:"test-btn"}," 测试+10经验 ")])]),s("div",Ve,[o[9]||(o[9]=s("h3",null,"当前特权",-1)),s("div",Je,[(r(!0),i(F,null,P(R.value,l=>(r(),i("div",{key:l.id,class:"privilege-item"},[s("span",qe,u(l.icon),1),s("span",Oe,u(l.name),1)]))),128))])])]),s("div",Re,[o[12]||(o[12]=s("h3",null,"我的帖子",-1)),p.value.length>0?(r(),i("div",je,[(r(!0),i(F,null,P(p.value,l=>(r(),ae(re,{key:l.id,post:l,onLike:T,onComment:Z},null,8,["post"]))),128))])):(r(),i("div",Xe,[o[11]||(o[11]=s("p",null,"还没有发布过帖子",-1)),b(a,{to:"/",class:"btn-primary"},{default:E(()=>[...o[10]||(o[10]=[x("去发布第一个帖子",-1)])]),_:1})]))])])):(r(),i("div",Te,[...o[13]||(o[13]=[s("p",null,"用户信息加载失败",-1)])]))])]),n.value?(r(),i("div",{key:0,class:"modal-overlay",onClick:o[2]||(o[2]=te(l=>n.value=!1,["self"]))},[s("div",Ze,[b(he,{onClose:o[1]||(o[1]=l=>n.value=!1),onSelect:G})])])):L("",!0)])}}}),so=J(Ge,[["__scopeId","data-v-f69881ac"]]);export{so as default};
//# sourceMappingURL=ProfileView-xPtkhRfl.js.map
