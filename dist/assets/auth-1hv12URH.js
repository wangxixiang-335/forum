import{s as i,D as z,r as _,c as h}from"./index-CtP2hjPR.js";async function S(s){var o,u,I,w;try{console.log("👤 检查用户资料是否存在...",s.id);const{data:g,error:c}=await i.from("profiles").select("*").eq("id",s.id).single();if(c)if(c.code==="PGRST116")console.log("📭 用户资料不存在，将创建新资料");else{if(console.warn("⚠️ 获取用户资料失败:",c.message),c.status===406||c.status===403||c.message.includes("permission")||c.message.includes("row-level security")){const e={id:s.id,username:((o=s.user_metadata)==null?void 0:o.username)||((u=s.email)==null?void 0:u.split("@")[0])||`user_${s.id.slice(0,8)}`,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()};return J.set(s.id,e),console.log("🔧 使用模拟资料（获取用户资料时遇到RLS问题）"),{success:!0,profile:e,created:!1}}throw c}if(g)return console.log("✅ 用户资料已存在"),{success:!0,profile:g,created:!1};console.log("➕ 创建新用户资料...");const d=((I=s.user_metadata)==null?void 0:I.username)||((w=s.email)==null?void 0:w.split("@")[0])||`user_${s.id.slice(0,8)}`,v={id:s.id,username:d,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},{data:b,error:l}=await i.from("profiles").insert(v).select().single();if(l){if(l.code==="23505"&&l.message.includes("username")){console.log("🔄 用户名冲突，尝试生成唯一用户名...");const e=`${d}_${Date.now().toString().slice(-4)}`;v.username=e;const{data:r,error:t}=await i.from("profiles").insert(v).select().single();if(t)throw t;return console.log("✅ 用户资料创建成功（使用唯一用户名）"),{success:!0,profile:r,created:!0}}if(l.code==="42501"||l.message.includes("permission")||l.status===403||l.message.includes("row-level security")){console.warn("🔒 权限不足，无法创建用户资料:",l.message);const e={message:"数据库权限受限，无法创建用户资料",solution:"请检查Supabase RLS策略配置",errorCode:l.code,status:l.status};console.error("❌ RLS策略错误详情:",e);const r={id:s.id,username:d,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()};return J.set(s.id,r),console.log("🔧 使用模拟资料（RLS策略问题，临时解决方案）"),{success:!0,profile:r,created:!0,warning:"使用模拟数据（RLS策略需要修复）"}}throw l}return console.log("✅ 用户资料创建成功"),{success:!0,profile:b,created:!0}}catch(g){return console.error("❌ 确保用户资料存在失败:",g),{success:!1,error:g.message,created:!1}}}const J=new Map;function O(s){return J.get(s)||null}const M=z("auth",()=>{const s=_(null),o=_(null),u=_(!1),I=h(()=>!!s.value),w=h(()=>{var e;return((e=o.value)==null?void 0:e.level)||1}),g=h(()=>{var e;return((e=o.value)==null?void 0:e.experience_points)||0}),c=async()=>{try{const{data:{session:e},error:r}=await i.auth.getSession();if(r&&i.supabaseUrl.includes("default.supabase.co")){console.warn("使用默认Supabase配置，跳过认证初始化");return}e!=null&&e.user&&(s.value=e.user,await d())}catch(e){console.warn("认证初始化失败:",e)}},d=async()=>{var e,r,t;if(s.value)try{const n="https://bkintupjzbcjiqvzricz.supabase.co",p="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!n||!p||n.includes("default.supabase.co")||p.includes("default")){const f=O(s.value.id);if(f){o.value=f;return}}const a=await S(s.value);a.success&&a.profile?(o.value=a.profile,console.log("✅ 用户资料获取/创建成功")):(console.warn("⚠️ 用户资料获取失败，使用默认资料"),a.error&&(a.error.includes("403")||a.error.includes("406")||a.error.includes("permission"))&&console.warn("🔒 数据库权限受限，使用本地资料模式"),o.value={id:s.value.id,username:((e=s.value.email)==null?void 0:e.split("@")[0])||((r=s.value.user_metadata)==null?void 0:r.username)||"user",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()})}catch(n){console.error("❌ 获取用户资料失败:",n),o.value={id:s.value.id,username:((t=s.value.email)==null?void 0:t.split("@")[0])||"user",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()}}},v=async(e,r)=>{u.value=!0;try{const t="https://bkintupjzbcjiqvzricz.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!t||!n||t.includes("default.supabase.co")||n.includes("default"))return console.warn("开发模式：模拟登录流程（真实Supabase配置无效）"),s.value={id:"dev-user-id",email:e,user_metadata:{username:"devuser"}},o.value={id:"dev-user-id",username:"devuser",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},{success:!0};console.log("🔐 尝试真实Supabase登录...");const{data:p,error:a}=await i.auth.signInWithPassword({email:e,password:r});if(a){if(console.error("Supabase登录错误:",a),a.status===400||a.message.includes("Invalid"))return console.warn("Supabase配置无效，回退到开发模式"),s.value={id:"dev-user-id",email:e,user_metadata:{username:"devuser"}},o.value={id:"dev-user-id",username:"devuser",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},{success:!0};throw a}return p.user&&(s.value=p.user,await d(),console.log("✅ 真实Supabase登录成功")),{success:!0}}catch(t){return console.error("登录错误:",t),{success:!1,error:t.message}}finally{u.value=!1}},b=async(e,r,t)=>{u.value=!0;try{const n="https://bkintupjzbcjiqvzricz.supabase.co",p="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!n||!p||n.includes("default.supabase.co")||p.includes("default")){console.warn("开发模式：模拟注册流程（真实Supabase配置无效）");const m={id:"mock-"+Date.now(),email:e,user_metadata:{username:t}};return(await S(m)).success&&console.log("✅ 开发模式：用户资料创建成功"),{success:!0,message:"开发模式：注册成功（模拟）",user:m}}console.log("🔐 尝试真实Supabase注册...");const{data:a,error:f}=await i.auth.signUp({email:e,password:r,options:{data:{username:t}}});if(f){if(console.error("Supabase注册错误:",f),f.status===400||f.message.includes("Invalid")){console.warn("Supabase配置无效，回退到开发模式");const m={id:"mock-"+Date.now(),email:e,user_metadata:{username:t}};return(await S(m)).success&&console.log("✅ 开发模式：用户资料创建成功"),{success:!0,message:"开发模式：注册成功（模拟）",user:m}}throw f}if(console.log("✅ 真实Supabase注册成功"),a.user){console.log("👤 确保新注册用户的资料存在...");const m=await S(a.user);m.success?console.log("✅ 用户资料创建/获取成功"):console.warn("⚠️ 用户资料创建失败:",m.error)}return{success:!0,user:a.user}}catch(n){return console.error("注册错误:",n),{success:!1,error:n.message}}finally{u.value=!1}},l=async()=>{const{error:e}=await i.auth.signOut();e||(s.value=null,o.value=null)};return i.auth.onAuthStateChange(async(e,r)=>{e==="SIGNED_IN"&&(r!=null&&r.user)?(s.value=r.user,await d()):e==="SIGNED_OUT"&&(s.value=null,o.value=null)}),{user:s,profile:o,isLoading:u,isAuthenticated:I,currentLevel:w,experiencePoints:g,initializeAuth:c,signIn:v,signUp:b,signOut:l,fetchProfile:d}});export{M as useAuthStore};
//# sourceMappingURL=auth-1hv12URH.js.map
