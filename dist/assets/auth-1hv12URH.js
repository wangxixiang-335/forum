import{s as i,D as z,r as _,c as h}from"./index-CtP2hjPR.js";async function S(s){var o,u,I,w;try{console.log("ðŸ‘¤ æ£€æŸ¥ç”¨æˆ·èµ„æ–™æ˜¯å¦å­˜åœ¨...",s.id);const{data:g,error:c}=await i.from("profiles").select("*").eq("id",s.id).single();if(c)if(c.code==="PGRST116")console.log("ðŸ“­ ç”¨æˆ·èµ„æ–™ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°èµ„æ–™");else{if(console.warn("âš ï¸ èŽ·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:",c.message),c.status===406||c.status===403||c.message.includes("permission")||c.message.includes("row-level security")){const e={id:s.id,username:((o=s.user_metadata)==null?void 0:o.username)||((u=s.email)==null?void 0:u.split("@")[0])||`user_${s.id.slice(0,8)}`,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()};return J.set(s.id,e),console.log("ðŸ”§ ä½¿ç”¨æ¨¡æ‹Ÿèµ„æ–™ï¼ˆèŽ·å–ç”¨æˆ·èµ„æ–™æ—¶é‡åˆ°RLSé—®é¢˜ï¼‰"),{success:!0,profile:e,created:!1}}throw c}if(g)return console.log("âœ… ç”¨æˆ·èµ„æ–™å·²å­˜åœ¨"),{success:!0,profile:g,created:!1};console.log("âž• åˆ›å»ºæ–°ç”¨æˆ·èµ„æ–™...");const d=((I=s.user_metadata)==null?void 0:I.username)||((w=s.email)==null?void 0:w.split("@")[0])||`user_${s.id.slice(0,8)}`,v={id:s.id,username:d,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},{data:b,error:l}=await i.from("profiles").insert(v).select().single();if(l){if(l.code==="23505"&&l.message.includes("username")){console.log("ðŸ”„ ç”¨æˆ·åå†²çªï¼Œå°è¯•ç”Ÿæˆå”¯ä¸€ç”¨æˆ·å...");const e=`${d}_${Date.now().toString().slice(-4)}`;v.username=e;const{data:r,error:t}=await i.from("profiles").insert(v).select().single();if(t)throw t;return console.log("âœ… ç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸï¼ˆä½¿ç”¨å”¯ä¸€ç”¨æˆ·åï¼‰"),{success:!0,profile:r,created:!0}}if(l.code==="42501"||l.message.includes("permission")||l.status===403||l.message.includes("row-level security")){console.warn("ðŸ”’ æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºç”¨æˆ·èµ„æ–™:",l.message);const e={message:"æ•°æ®åº“æƒé™å—é™ï¼Œæ— æ³•åˆ›å»ºç”¨æˆ·èµ„æ–™",solution:"è¯·æ£€æŸ¥Supabase RLSç­–ç•¥é…ç½®",errorCode:l.code,status:l.status};console.error("âŒ RLSç­–ç•¥é”™è¯¯è¯¦æƒ…:",e);const r={id:s.id,username:d,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()};return J.set(s.id,r),console.log("ðŸ”§ ä½¿ç”¨æ¨¡æ‹Ÿèµ„æ–™ï¼ˆRLSç­–ç•¥é—®é¢˜ï¼Œä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼‰"),{success:!0,profile:r,created:!0,warning:"ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆRLSç­–ç•¥éœ€è¦ä¿®å¤ï¼‰"}}throw l}return console.log("âœ… ç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸ"),{success:!0,profile:b,created:!0}}catch(g){return console.error("âŒ ç¡®ä¿ç”¨æˆ·èµ„æ–™å­˜åœ¨å¤±è´¥:",g),{success:!1,error:g.message,created:!1}}}const J=new Map;function O(s){return J.get(s)||null}const M=z("auth",()=>{const s=_(null),o=_(null),u=_(!1),I=h(()=>!!s.value),w=h(()=>{var e;return((e=o.value)==null?void 0:e.level)||1}),g=h(()=>{var e;return((e=o.value)==null?void 0:e.experience_points)||0}),c=async()=>{try{const{data:{session:e},error:r}=await i.auth.getSession();if(r&&i.supabaseUrl.includes("default.supabase.co")){console.warn("ä½¿ç”¨é»˜è®¤Supabaseé…ç½®ï¼Œè·³è¿‡è®¤è¯åˆå§‹åŒ–");return}e!=null&&e.user&&(s.value=e.user,await d())}catch(e){console.warn("è®¤è¯åˆå§‹åŒ–å¤±è´¥:",e)}},d=async()=>{var e,r,t;if(s.value)try{const n="https://bkintupjzbcjiqvzricz.supabase.co",p="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!n||!p||n.includes("default.supabase.co")||p.includes("default")){const f=O(s.value.id);if(f){o.value=f;return}}const a=await S(s.value);a.success&&a.profile?(o.value=a.profile,console.log("âœ… ç”¨æˆ·èµ„æ–™èŽ·å–/åˆ›å»ºæˆåŠŸ")):(console.warn("âš ï¸ ç”¨æˆ·èµ„æ–™èŽ·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤èµ„æ–™"),a.error&&(a.error.includes("403")||a.error.includes("406")||a.error.includes("permission"))&&console.warn("ðŸ”’ æ•°æ®åº“æƒé™å—é™ï¼Œä½¿ç”¨æœ¬åœ°èµ„æ–™æ¨¡å¼"),o.value={id:s.value.id,username:((e=s.value.email)==null?void 0:e.split("@")[0])||((r=s.value.user_metadata)==null?void 0:r.username)||"user",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()})}catch(n){console.error("âŒ èŽ·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:",n),o.value={id:s.value.id,username:((t=s.value.email)==null?void 0:t.split("@")[0])||"user",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()}}},v=async(e,r)=>{u.value=!0;try{const t="https://bkintupjzbcjiqvzricz.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!t||!n||t.includes("default.supabase.co")||n.includes("default"))return console.warn("å¼€å‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿç™»å½•æµç¨‹ï¼ˆçœŸå®žSupabaseé…ç½®æ— æ•ˆï¼‰"),s.value={id:"dev-user-id",email:e,user_metadata:{username:"devuser"}},o.value={id:"dev-user-id",username:"devuser",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},{success:!0};console.log("ðŸ” å°è¯•çœŸå®žSupabaseç™»å½•...");const{data:p,error:a}=await i.auth.signInWithPassword({email:e,password:r});if(a){if(console.error("Supabaseç™»å½•é”™è¯¯:",a),a.status===400||a.message.includes("Invalid"))return console.warn("Supabaseé…ç½®æ— æ•ˆï¼Œå›žé€€åˆ°å¼€å‘æ¨¡å¼"),s.value={id:"dev-user-id",email:e,user_metadata:{username:"devuser"}},o.value={id:"dev-user-id",username:"devuser",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},{success:!0};throw a}return p.user&&(s.value=p.user,await d(),console.log("âœ… çœŸå®žSupabaseç™»å½•æˆåŠŸ")),{success:!0}}catch(t){return console.error("ç™»å½•é”™è¯¯:",t),{success:!1,error:t.message}}finally{u.value=!1}},b=async(e,r,t)=>{u.value=!0;try{const n="https://bkintupjzbcjiqvzricz.supabase.co",p="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!n||!p||n.includes("default.supabase.co")||p.includes("default")){console.warn("å¼€å‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿæ³¨å†Œæµç¨‹ï¼ˆçœŸå®žSupabaseé…ç½®æ— æ•ˆï¼‰");const m={id:"mock-"+Date.now(),email:e,user_metadata:{username:t}};return(await S(m)).success&&console.log("âœ… å¼€å‘æ¨¡å¼ï¼šç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸ"),{success:!0,message:"å¼€å‘æ¨¡å¼ï¼šæ³¨å†ŒæˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰",user:m}}console.log("ðŸ” å°è¯•çœŸå®žSupabaseæ³¨å†Œ...");const{data:a,error:f}=await i.auth.signUp({email:e,password:r,options:{data:{username:t}}});if(f){if(console.error("Supabaseæ³¨å†Œé”™è¯¯:",f),f.status===400||f.message.includes("Invalid")){console.warn("Supabaseé…ç½®æ— æ•ˆï¼Œå›žé€€åˆ°å¼€å‘æ¨¡å¼");const m={id:"mock-"+Date.now(),email:e,user_metadata:{username:t}};return(await S(m)).success&&console.log("âœ… å¼€å‘æ¨¡å¼ï¼šç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸ"),{success:!0,message:"å¼€å‘æ¨¡å¼ï¼šæ³¨å†ŒæˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰",user:m}}throw f}if(console.log("âœ… çœŸå®žSupabaseæ³¨å†ŒæˆåŠŸ"),a.user){console.log("ðŸ‘¤ ç¡®ä¿æ–°æ³¨å†Œç”¨æˆ·çš„èµ„æ–™å­˜åœ¨...");const m=await S(a.user);m.success?console.log("âœ… ç”¨æˆ·èµ„æ–™åˆ›å»º/èŽ·å–æˆåŠŸ"):console.warn("âš ï¸ ç”¨æˆ·èµ„æ–™åˆ›å»ºå¤±è´¥:",m.error)}return{success:!0,user:a.user}}catch(n){return console.error("æ³¨å†Œé”™è¯¯:",n),{success:!1,error:n.message}}finally{u.value=!1}},l=async()=>{const{error:e}=await i.auth.signOut();e||(s.value=null,o.value=null)};return i.auth.onAuthStateChange(async(e,r)=>{e==="SIGNED_IN"&&(r!=null&&r.user)?(s.value=r.user,await d()):e==="SIGNED_OUT"&&(s.value=null,o.value=null)}),{user:s,profile:o,isLoading:u,isAuthenticated:I,currentLevel:w,experiencePoints:g,initializeAuth:c,signIn:v,signUp:b,signOut:l,fetchProfile:d}});export{M as useAuthStore};
//# sourceMappingURL=auth-1hv12URH.js.map
