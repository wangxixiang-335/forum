import{x as p,I as z,r as h,c as E}from"./index-02sh5J2l.js";async function _(s){var r,f,S,w;try{console.log("ğŸ‘¤ æ£€æŸ¥ç”¨æˆ·èµ„æ–™æ˜¯å¦å­˜åœ¨...",s.id);const{data:g,error:d}=await p.from("profiles").select("*").eq("id",s.id).single();if(d)if(d.code==="PGRST116")console.log("ğŸ“­ ç”¨æˆ·èµ„æ–™ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°èµ„æ–™");else{if(console.warn("âš ï¸ è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:",d.message),d.status===406||d.status===403||d.message.includes("permission")||d.message.includes("row-level security")){const m={id:s.id,username:((r=s.user_metadata)==null?void 0:r.username)||((f=s.email)==null?void 0:f.split("@")[0])||`user_${s.id.slice(0,8)}`,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()};return x.set(s.id,m),console.log("ğŸ”§ ä½¿ç”¨æ¨¡æ‹Ÿèµ„æ–™ï¼ˆè·å–ç”¨æˆ·èµ„æ–™æ—¶é‡åˆ°RLSé—®é¢˜ï¼‰"),{success:!0,profile:m,created:!1}}throw d}if(g)return console.log("âœ… ç”¨æˆ·èµ„æ–™å·²å­˜åœ¨"),{success:!0,profile:g,created:!1};console.log("â• åˆ›å»ºæ–°ç”¨æˆ·èµ„æ–™...");const v=((S=s.user_metadata)==null?void 0:S.username)||((w=s.email)==null?void 0:w.split("@")[0])||`user_${s.id.slice(0,8)}`,I={id:s.id,username:v,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},{data:b,error:n}=await p.from("profiles").insert(I).select().single();if(n){if(n.code==="23505"&&n.message.includes("username")){console.log("ğŸ”„ ç”¨æˆ·åå†²çªï¼Œå°è¯•ç”Ÿæˆå”¯ä¸€ç”¨æˆ·å...");const m=`${v}_${Date.now().toString().slice(-4)}`;I.username=m;const{data:e,error:a}=await p.from("profiles").insert(I).select().single();if(a)throw a;return console.log("âœ… ç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸï¼ˆä½¿ç”¨å”¯ä¸€ç”¨æˆ·åï¼‰"),{success:!0,profile:e,created:!0}}if(n.code==="42501"||n.message.includes("permission")||n.status===403||n.message.includes("row-level security")){console.warn("ğŸ”’ æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºç”¨æˆ·èµ„æ–™:",n.message);const m={message:"æ•°æ®åº“æƒé™å—é™ï¼Œæ— æ³•åˆ›å»ºç”¨æˆ·èµ„æ–™",solution:"è¯·æ£€æŸ¥Supabase RLSç­–ç•¥é…ç½®",errorCode:n.code,status:n.status};console.error("âŒ RLSç­–ç•¥é”™è¯¯è¯¦æƒ…:",m);const e={id:s.id,username:v,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()};return x.set(s.id,e),console.log("ğŸ”§ ä½¿ç”¨æ¨¡æ‹Ÿèµ„æ–™ï¼ˆRLSç­–ç•¥é—®é¢˜ï¼Œä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼‰"),{success:!0,profile:e,created:!0,warning:"ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆRLSç­–ç•¥éœ€è¦ä¿®å¤ï¼‰"}}throw n}return console.log("âœ… ç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸ"),{success:!0,profile:b,created:!0}}catch(g){return console.error("âŒ ç¡®ä¿ç”¨æˆ·èµ„æ–™å­˜åœ¨å¤±è´¥:",g),{success:!1,error:g.message,created:!1}}}const x=new Map;const D=z("auth",()=>{const s=h(null),r=h(null),f=h(!1),S=E(()=>!!s.value),w=E(()=>{var e;return((e=r.value)==null?void 0:e.level)||1}),g=E(()=>{var e;return((e=r.value)==null?void 0:e.experience_points)||0}),d=async()=>{try{console.log("å¼€å§‹åˆå§‹åŒ–è®¤è¯çŠ¶æ€...");const e="https://bkintupjzbcjiqvzricz.supabase.co";if(!e||e.includes("default.supabase.co")){console.log("ä½¿ç”¨é»˜è®¤Supabaseé…ç½®ï¼Œåˆ›å»ºæ¨¡æ‹Ÿç”¨æˆ·"),s.value={id:"dev-user-id",email:"dev@example.com",user_metadata:{username:"devuser"}},r.value={id:"dev-user-id",username:"devuser",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},console.log("å¼€å‘æ¨¡å¼è®¤è¯åˆå§‹åŒ–å®Œæˆ");return}const{data:{session:a},error:t}=await p.auth.getSession();if(t){console.error("è·å–sessionå¤±è´¥:",t);return}a!=null&&a.user?(console.log("æ‰¾åˆ°æœ‰æ•ˆsessionï¼Œç”¨æˆ·ID:",a.user.id),s.value=a.user,await v(),console.log("è®¤è¯åˆå§‹åŒ–å®Œæˆ")):console.log("æœªæ‰¾åˆ°æœ‰æ•ˆsession")}catch(e){console.warn("è®¤è¯åˆå§‹åŒ–å¤±è´¥:",e)}},v=async()=>{var e,a,t,u,i;if(!s.value){console.warn("fetchProfile: ç”¨æˆ·æœªç™»å½•");return}try{const o="https://bkintupjzbcjiqvzricz.supabase.co",c="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!o||!c||o.includes("default.supabase.co")||c.includes("default")){console.log("ä½¿ç”¨å¼€å‘æ¨¡å¼æ¨¡æ‹Ÿèµ„æ–™"),r.value={id:s.value.id,username:((e=s.value.user_metadata)==null?void 0:e.username)||"user",avatar_url:null,level:1,experience_points:25,created_at:new Date().toISOString()};return}const l=await _(s.value);l.success&&l.profile?(r.value=l.profile,console.log("âœ… ç”¨æˆ·èµ„æ–™è·å–/åˆ›å»ºæˆåŠŸ")):(console.warn("âš ï¸ ç”¨æˆ·èµ„æ–™è·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤èµ„æ–™:",l.error),l.error&&(l.error.includes("403")||l.error.includes("406")||l.error.includes("permission"))&&console.warn("ğŸ”’ æ•°æ®åº“æƒé™å—é™ï¼Œä½¿ç”¨æœ¬åœ°èµ„æ–™æ¨¡å¼"),r.value={id:s.value.id,username:((a=s.value.email)==null?void 0:a.split("@")[0])||((t=s.value.user_metadata)==null?void 0:t.username)||"user",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()})}catch(o){console.error("âŒ è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:",o),r.value={id:s.value.id,username:((u=s.value.email)==null?void 0:u.split("@")[0])||((i=s.value.user_metadata)==null?void 0:i.username)||"user",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()}}},I=async(e,a)=>{f.value=!0;try{const t="https://bkintupjzbcjiqvzricz.supabase.co",u="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!t||!u||t.includes("default.supabase.co")||u.includes("default"))return console.warn("å¼€å‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿç™»å½•æµç¨‹ï¼ˆçœŸå®Supabaseé…ç½®æ— æ•ˆï¼‰"),s.value={id:"dev-user-id",email:e,user_metadata:{username:"devuser"}},r.value={id:"dev-user-id",username:"devuser",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},{success:!0};console.log("ğŸ” å°è¯•çœŸå®Supabaseç™»å½•...");const{data:i,error:o}=await p.auth.signInWithPassword({email:e,password:a});if(o){if(console.error("Supabaseç™»å½•é”™è¯¯:",o),o.status===400||o.message.includes("Invalid"))return console.warn("Supabaseé…ç½®æ— æ•ˆï¼Œå›é€€åˆ°å¼€å‘æ¨¡å¼"),s.value={id:"dev-user-id",email:e,user_metadata:{username:"devuser"}},r.value={id:"dev-user-id",username:"devuser",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},{success:!0};throw o}return i.user&&(s.value=i.user,await v(),console.log("âœ… çœŸå®Supabaseç™»å½•æˆåŠŸ")),{success:!0}}catch(t){return console.error("ç™»å½•é”™è¯¯:",t),{success:!1,error:t.message}}finally{f.value=!1}},b=async(e,a,t)=>{f.value=!0;try{const u="https://bkintupjzbcjiqvzricz.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!u||!i||u.includes("default.supabase.co")||i.includes("default")){console.warn("å¼€å‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿæ³¨å†Œæµç¨‹ï¼ˆçœŸå®Supabaseé…ç½®æ— æ•ˆï¼‰");const l={id:"mock-"+Date.now(),email:e,user_metadata:{username:t}};return(await _(l)).success&&console.log("âœ… å¼€å‘æ¨¡å¼ï¼šç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸ"),{success:!0,message:"å¼€å‘æ¨¡å¼ï¼šæ³¨å†ŒæˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰",user:l}}console.log("ğŸ” å°è¯•çœŸå®Supabaseæ³¨å†Œ...");const{data:o,error:c}=await p.auth.signUp({email:e,password:a,options:{data:{username:t}}});if(c){if(console.error("Supabaseæ³¨å†Œé”™è¯¯:",c),c.status===400||c.message.includes("Invalid")){console.warn("Supabaseé…ç½®æ— æ•ˆï¼Œå›é€€åˆ°å¼€å‘æ¨¡å¼");const l={id:"mock-"+Date.now(),email:e,user_metadata:{username:t}};return(await _(l)).success&&console.log("âœ… å¼€å‘æ¨¡å¼ï¼šç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸ"),{success:!0,message:"å¼€å‘æ¨¡å¼ï¼šæ³¨å†ŒæˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰",user:l}}throw c}if(console.log("âœ… çœŸå®Supabaseæ³¨å†ŒæˆåŠŸ"),o.user){console.log("ğŸ‘¤ ç¡®ä¿æ–°æ³¨å†Œç”¨æˆ·çš„èµ„æ–™å­˜åœ¨...");const l=await _(o.user);l.success?console.log("âœ… ç”¨æˆ·èµ„æ–™åˆ›å»º/è·å–æˆåŠŸ"):console.warn("âš ï¸ ç”¨æˆ·èµ„æ–™åˆ›å»ºå¤±è´¥:",l.error)}return{success:!0,user:o.user}}catch(u){return console.error("æ³¨å†Œé”™è¯¯:",u),{success:!1,error:u.message}}finally{f.value=!1}},n=async e=>{if(r.value)try{r.value.experience_points+=e;const a=r.value.level,u=(c=>{const l=[0,50,150,300,500,800,1200,1800,2500,3500,5e3,7e3,1e4];if(c<=1)return 0;if(c>=l.length){const J=l[l.length-1],y=c-l.length+1;return J+y*2e3}return l[c-1]})(a+1);r.value.experience_points>=u&&(r.value.level+=1,console.log(`ğŸ‰ æ­å–œå‡çº§ï¼å½“å‰ç­‰çº§: Lv.${r.value.level}`));const i="https://bkintupjzbcjiqvzricz.supabase.co",o="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!i||!o||i.includes("default.supabase.co")||o.includes("default")){console.log("å¼€å‘æ¨¡å¼ï¼šç»éªŒå€¼å·²æ›´æ–°åˆ°æœ¬åœ°çŠ¶æ€");return}await p.from("profiles").update({experience_points:r.value.experience_points,level:r.value.level,updated_at:new Date().toISOString()}).eq("id",r.value.id)}catch(a){console.error("æ›´æ–°ç»éªŒå€¼å¤±è´¥:",a),r.value.experience_points-=e,r.value.level>1&&(r.value.level-=1)}},m=async()=>{const{error:e}=await p.auth.signOut();e||(s.value=null,r.value=null)};return p.auth.onAuthStateChange(async(e,a)=>{var t;console.log("ğŸ” è®¤è¯çŠ¶æ€å˜åŒ–:",e,(t=a==null?void 0:a.user)==null?void 0:t.id),e==="SIGNED_IN"&&(a!=null&&a.user)?(console.log("âœ… ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œè®¾ç½®ç”¨æˆ·ä¿¡æ¯"),s.value=a.user,await v()):e==="SIGNED_OUT"?(console.log("ğŸ‘‹ ç”¨æˆ·ç™»å‡ºï¼Œæ¸…é™¤ç”¨æˆ·ä¿¡æ¯"),s.value=null,r.value=null):e==="TOKEN_REFRESHED"?console.log("ğŸ”„ ä»¤ç‰Œå·²åˆ·æ–°"):e==="USER_UPDATED"&&console.log("ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°")}),{user:s,profile:r,isLoading:f,isAuthenticated:S,currentLevel:w,experiencePoints:g,initializeAuth:d,signIn:I,signUp:b,signOut:m,fetchProfile:v,updateExperience:n}});export{D as useAuthStore};
//# sourceMappingURL=auth-DsvB8qh0.js.map
