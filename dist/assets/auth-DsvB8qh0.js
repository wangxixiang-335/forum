import{x as p,I as z,r as h,c as E}from"./index-02sh5J2l.js";async function _(s){var r,f,S,w;try{console.log("👤 检查用户资料是否存在...",s.id);const{data:g,error:d}=await p.from("profiles").select("*").eq("id",s.id).single();if(d)if(d.code==="PGRST116")console.log("📭 用户资料不存在，将创建新资料");else{if(console.warn("⚠️ 获取用户资料失败:",d.message),d.status===406||d.status===403||d.message.includes("permission")||d.message.includes("row-level security")){const m={id:s.id,username:((r=s.user_metadata)==null?void 0:r.username)||((f=s.email)==null?void 0:f.split("@")[0])||`user_${s.id.slice(0,8)}`,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()};return x.set(s.id,m),console.log("🔧 使用模拟资料（获取用户资料时遇到RLS问题）"),{success:!0,profile:m,created:!1}}throw d}if(g)return console.log("✅ 用户资料已存在"),{success:!0,profile:g,created:!1};console.log("➕ 创建新用户资料...");const v=((S=s.user_metadata)==null?void 0:S.username)||((w=s.email)==null?void 0:w.split("@")[0])||`user_${s.id.slice(0,8)}`,I={id:s.id,username:v,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},{data:b,error:n}=await p.from("profiles").insert(I).select().single();if(n){if(n.code==="23505"&&n.message.includes("username")){console.log("🔄 用户名冲突，尝试生成唯一用户名...");const m=`${v}_${Date.now().toString().slice(-4)}`;I.username=m;const{data:e,error:a}=await p.from("profiles").insert(I).select().single();if(a)throw a;return console.log("✅ 用户资料创建成功（使用唯一用户名）"),{success:!0,profile:e,created:!0}}if(n.code==="42501"||n.message.includes("permission")||n.status===403||n.message.includes("row-level security")){console.warn("🔒 权限不足，无法创建用户资料:",n.message);const m={message:"数据库权限受限，无法创建用户资料",solution:"请检查Supabase RLS策略配置",errorCode:n.code,status:n.status};console.error("❌ RLS策略错误详情:",m);const e={id:s.id,username:v,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()};return x.set(s.id,e),console.log("🔧 使用模拟资料（RLS策略问题，临时解决方案）"),{success:!0,profile:e,created:!0,warning:"使用模拟数据（RLS策略需要修复）"}}throw n}return console.log("✅ 用户资料创建成功"),{success:!0,profile:b,created:!0}}catch(g){return console.error("❌ 确保用户资料存在失败:",g),{success:!1,error:g.message,created:!1}}}const x=new Map;const D=z("auth",()=>{const s=h(null),r=h(null),f=h(!1),S=E(()=>!!s.value),w=E(()=>{var e;return((e=r.value)==null?void 0:e.level)||1}),g=E(()=>{var e;return((e=r.value)==null?void 0:e.experience_points)||0}),d=async()=>{try{console.log("开始初始化认证状态...");const e="https://bkintupjzbcjiqvzricz.supabase.co";if(!e||e.includes("default.supabase.co")){console.log("使用默认Supabase配置，创建模拟用户"),s.value={id:"dev-user-id",email:"dev@example.com",user_metadata:{username:"devuser"}},r.value={id:"dev-user-id",username:"devuser",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},console.log("开发模式认证初始化完成");return}const{data:{session:a},error:t}=await p.auth.getSession();if(t){console.error("获取session失败:",t);return}a!=null&&a.user?(console.log("找到有效session，用户ID:",a.user.id),s.value=a.user,await v(),console.log("认证初始化完成")):console.log("未找到有效session")}catch(e){console.warn("认证初始化失败:",e)}},v=async()=>{var e,a,t,u,i;if(!s.value){console.warn("fetchProfile: 用户未登录");return}try{const o="https://bkintupjzbcjiqvzricz.supabase.co",c="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!o||!c||o.includes("default.supabase.co")||c.includes("default")){console.log("使用开发模式模拟资料"),r.value={id:s.value.id,username:((e=s.value.user_metadata)==null?void 0:e.username)||"user",avatar_url:null,level:1,experience_points:25,created_at:new Date().toISOString()};return}const l=await _(s.value);l.success&&l.profile?(r.value=l.profile,console.log("✅ 用户资料获取/创建成功")):(console.warn("⚠️ 用户资料获取失败，使用默认资料:",l.error),l.error&&(l.error.includes("403")||l.error.includes("406")||l.error.includes("permission"))&&console.warn("🔒 数据库权限受限，使用本地资料模式"),r.value={id:s.value.id,username:((a=s.value.email)==null?void 0:a.split("@")[0])||((t=s.value.user_metadata)==null?void 0:t.username)||"user",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()})}catch(o){console.error("❌ 获取用户资料失败:",o),r.value={id:s.value.id,username:((u=s.value.email)==null?void 0:u.split("@")[0])||((i=s.value.user_metadata)==null?void 0:i.username)||"user",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()}}},I=async(e,a)=>{f.value=!0;try{const t="https://bkintupjzbcjiqvzricz.supabase.co",u="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!t||!u||t.includes("default.supabase.co")||u.includes("default"))return console.warn("开发模式：模拟登录流程（真实Supabase配置无效）"),s.value={id:"dev-user-id",email:e,user_metadata:{username:"devuser"}},r.value={id:"dev-user-id",username:"devuser",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},{success:!0};console.log("🔐 尝试真实Supabase登录...");const{data:i,error:o}=await p.auth.signInWithPassword({email:e,password:a});if(o){if(console.error("Supabase登录错误:",o),o.status===400||o.message.includes("Invalid"))return console.warn("Supabase配置无效，回退到开发模式"),s.value={id:"dev-user-id",email:e,user_metadata:{username:"devuser"}},r.value={id:"dev-user-id",username:"devuser",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},{success:!0};throw o}return i.user&&(s.value=i.user,await v(),console.log("✅ 真实Supabase登录成功")),{success:!0}}catch(t){return console.error("登录错误:",t),{success:!1,error:t.message}}finally{f.value=!1}},b=async(e,a,t)=>{f.value=!0;try{const u="https://bkintupjzbcjiqvzricz.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!u||!i||u.includes("default.supabase.co")||i.includes("default")){console.warn("开发模式：模拟注册流程（真实Supabase配置无效）");const l={id:"mock-"+Date.now(),email:e,user_metadata:{username:t}};return(await _(l)).success&&console.log("✅ 开发模式：用户资料创建成功"),{success:!0,message:"开发模式：注册成功（模拟）",user:l}}console.log("🔐 尝试真实Supabase注册...");const{data:o,error:c}=await p.auth.signUp({email:e,password:a,options:{data:{username:t}}});if(c){if(console.error("Supabase注册错误:",c),c.status===400||c.message.includes("Invalid")){console.warn("Supabase配置无效，回退到开发模式");const l={id:"mock-"+Date.now(),email:e,user_metadata:{username:t}};return(await _(l)).success&&console.log("✅ 开发模式：用户资料创建成功"),{success:!0,message:"开发模式：注册成功（模拟）",user:l}}throw c}if(console.log("✅ 真实Supabase注册成功"),o.user){console.log("👤 确保新注册用户的资料存在...");const l=await _(o.user);l.success?console.log("✅ 用户资料创建/获取成功"):console.warn("⚠️ 用户资料创建失败:",l.error)}return{success:!0,user:o.user}}catch(u){return console.error("注册错误:",u),{success:!1,error:u.message}}finally{f.value=!1}},n=async e=>{if(r.value)try{r.value.experience_points+=e;const a=r.value.level,u=(c=>{const l=[0,50,150,300,500,800,1200,1800,2500,3500,5e3,7e3,1e4];if(c<=1)return 0;if(c>=l.length){const J=l[l.length-1],y=c-l.length+1;return J+y*2e3}return l[c-1]})(a+1);r.value.experience_points>=u&&(r.value.level+=1,console.log(`🎉 恭喜升级！当前等级: Lv.${r.value.level}`));const i="https://bkintupjzbcjiqvzricz.supabase.co",o="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!i||!o||i.includes("default.supabase.co")||o.includes("default")){console.log("开发模式：经验值已更新到本地状态");return}await p.from("profiles").update({experience_points:r.value.experience_points,level:r.value.level,updated_at:new Date().toISOString()}).eq("id",r.value.id)}catch(a){console.error("更新经验值失败:",a),r.value.experience_points-=e,r.value.level>1&&(r.value.level-=1)}},m=async()=>{const{error:e}=await p.auth.signOut();e||(s.value=null,r.value=null)};return p.auth.onAuthStateChange(async(e,a)=>{var t;console.log("🔐 认证状态变化:",e,(t=a==null?void 0:a.user)==null?void 0:t.id),e==="SIGNED_IN"&&(a!=null&&a.user)?(console.log("✅ 用户登录成功，设置用户信息"),s.value=a.user,await v()):e==="SIGNED_OUT"?(console.log("👋 用户登出，清除用户信息"),s.value=null,r.value=null):e==="TOKEN_REFRESHED"?console.log("🔄 令牌已刷新"):e==="USER_UPDATED"&&console.log("👤 用户信息已更新")}),{user:s,profile:r,isLoading:f,isAuthenticated:S,currentLevel:w,experiencePoints:g,initializeAuth:d,signIn:I,signUp:b,signOut:m,fetchProfile:v,updateExperience:n}});export{D as useAuthStore};
//# sourceMappingURL=auth-DsvB8qh0.js.map
