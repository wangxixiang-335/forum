import{y as n,L as X,r as y,i as E}from"./index-DvT1nwGZ.js";async function h(s){var a,p,b,w;try{console.log("ğŸ‘¤ æ£€æŸ¥ç”¨æˆ·èµ„æ–™æ˜¯å¦å­˜åœ¨...",s.id);const{data:v,error:f}=await n.from("profiles").select("*").eq("id",s.id).single();if(f)if(f.code==="PGRST116")console.log("ğŸ“­ ç”¨æˆ·èµ„æ–™ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°èµ„æ–™");else{if(console.warn("âš ï¸ è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:",f.message),f.status===406||f.status===403||f.message.includes("permission")||f.message.includes("row-level security")){const m={id:s.id,username:((a=s.user_metadata)==null?void 0:a.username)||((p=s.email)==null?void 0:p.split("@")[0])||`user_${s.id.slice(0,8)}`,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()};return O.set(s.id,m),console.log("ğŸ”§ ä½¿ç”¨æ¨¡æ‹Ÿèµ„æ–™ï¼ˆè·å–ç”¨æˆ·èµ„æ–™æ—¶é‡åˆ°RLSé—®é¢˜ï¼‰"),{success:!0,profile:m,created:!1}}throw f}if(v)return console.log("âœ… ç”¨æˆ·èµ„æ–™å·²å­˜åœ¨"),{success:!0,profile:v,created:!1};console.log("â• åˆ›å»ºæ–°ç”¨æˆ·èµ„æ–™...");const I=((b=s.user_metadata)==null?void 0:b.username)||((w=s.email)==null?void 0:w.split("@")[0])||`user_${s.id.slice(0,8)}`,J={id:s.id,username:I,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},{data:z,error:d}=await n.from("profiles").insert(J).select().single();if(d){if(d.code==="23505"&&d.message.includes("username")){console.log("ğŸ”„ ç”¨æˆ·åå†²çªï¼Œå°è¯•ç”Ÿæˆå”¯ä¸€ç”¨æˆ·å...");const m=`${I}_${Date.now().toString().slice(-4)}`;J.username=m;const{data:g,error:S}=await n.from("profiles").insert(J).select().single();if(S)throw S;return console.log("âœ… ç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸï¼ˆä½¿ç”¨å”¯ä¸€ç”¨æˆ·åï¼‰"),{success:!0,profile:g,created:!0}}if(d.code==="42501"||d.message.includes("permission")||d.status===403||d.message.includes("row-level security")){console.warn("ğŸ”’ æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºç”¨æˆ·èµ„æ–™:",d.message);const m={message:"æ•°æ®åº“æƒé™å—é™ï¼Œæ— æ³•åˆ›å»ºç”¨æˆ·èµ„æ–™",solution:"è¯·æ£€æŸ¥Supabase RLSç­–ç•¥é…ç½®",errorCode:d.code,status:d.status};console.error("âŒ RLSç­–ç•¥é”™è¯¯è¯¦æƒ…:",m);const g={id:s.id,username:I,avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()};return O.set(s.id,g),console.log("ğŸ”§ ä½¿ç”¨æ¨¡æ‹Ÿèµ„æ–™ï¼ˆRLSç­–ç•¥é—®é¢˜ï¼Œä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼‰"),{success:!0,profile:g,created:!0,warning:"ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆRLSç­–ç•¥éœ€è¦ä¿®å¤ï¼‰"}}throw d}return console.log("âœ… ç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸ"),{success:!0,profile:z,created:!0}}catch(v){return console.error("âŒ ç¡®ä¿ç”¨æˆ·èµ„æ–™å­˜åœ¨å¤±è´¥:",v),{success:!1,error:v.message,created:!1}}}const O=new Map;const C=X("auth",()=>{const s=y(null),a=y(null),p=y(!1),b=E(()=>!!s.value),w=E(()=>{var e;return((e=a.value)==null?void 0:e.level)||1}),v=E(()=>{var e;return((e=a.value)==null?void 0:e.experience_points)||0}),f=async()=>{try{console.log("å¼€å§‹åˆå§‹åŒ–è®¤è¯çŠ¶æ€...");const e="https://bkintupjzbcjiqvzricz.supabase.co";if(!e||e.includes("default.supabase.co")){console.log("ä½¿ç”¨é»˜è®¤Supabaseé…ç½®ï¼Œåˆ›å»ºæ¨¡æ‹Ÿç”¨æˆ·"),s.value={id:"dev-user-id",email:"dev@example.com",user_metadata:{username:"devuser"}},a.value={id:"dev-user-id",username:"devuser",avatar_url:null,level:1,experience_points:0,created_at:new Date().toISOString()},console.log("å¼€å‘æ¨¡å¼è®¤è¯åˆå§‹åŒ–å®Œæˆ");return}const{data:{session:r},error:t}=await n.auth.getSession();if(t){console.error("è·å–sessionå¤±è´¥:",t);return}r!=null&&r.user?(console.log("æ‰¾åˆ°æœ‰æ•ˆsessionï¼Œç”¨æˆ·ID:",r.user.id),s.value=r.user,await I(),console.log("è®¤è¯åˆå§‹åŒ–å®Œæˆ")):console.log("æœªæ‰¾åˆ°æœ‰æ•ˆsession")}catch(e){console.warn("è®¤è¯åˆå§‹åŒ–å¤±è´¥:",e)}},I=async()=>{var e,r,t,u,i;if(!s.value){console.warn("fetchProfile: ç”¨æˆ·æœªç™»å½•");return}try{const l="https://bkintupjzbcjiqvzricz.supabase.co",c="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!l||!c||l.includes("default.supabase.co")||c.includes("default")){console.log("ä½¿ç”¨å¼€å‘æ¨¡å¼æ¨¡æ‹Ÿèµ„æ–™"),a.value={id:s.value.id,username:((e=s.value.user_metadata)==null?void 0:e.username)||"user",avatar_url:null,level:1,experience_points:25,signature:null,created_at:new Date().toISOString()};return}const o=await h(s.value);o.success&&o.profile?(a.value=o.profile,console.log("âœ… ç”¨æˆ·èµ„æ–™è·å–/åˆ›å»ºæˆåŠŸ")):(console.warn("âš ï¸ ç”¨æˆ·èµ„æ–™è·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤èµ„æ–™:",o.error),o.error&&(o.error.includes("403")||o.error.includes("406")||o.error.includes("permission"))&&console.warn("ğŸ”’ æ•°æ®åº“æƒé™å—é™ï¼Œä½¿ç”¨æœ¬åœ°èµ„æ–™æ¨¡å¼"),a.value={id:s.value.id,username:((r=s.value.email)==null?void 0:r.split("@")[0])||((t=s.value.user_metadata)==null?void 0:t.username)||"user",avatar_url:null,level:1,experience_points:0,signature:null,created_at:new Date().toISOString()})}catch(l){console.error("âŒ è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:",l),a.value={id:s.value.id,username:((u=s.value.email)==null?void 0:u.split("@")[0])||((i=s.value.user_metadata)==null?void 0:i.username)||"user",avatar_url:null,level:1,experience_points:0,signature:null,created_at:new Date().toISOString()}}},J=async(e,r)=>{p.value=!0;try{const t="https://bkintupjzbcjiqvzricz.supabase.co",u="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!t||!u||t.includes("default.supabase.co")||u.includes("default"))return console.warn("å¼€å‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿç™»å½•æµç¨‹ï¼ˆçœŸå®Supabaseé…ç½®æ— æ•ˆï¼‰"),s.value={id:"dev-user-id",email:e,user_metadata:{username:"devuser"}},a.value={id:"dev-user-id",username:"devuser",avatar_url:null,level:1,experience_points:0,signature:null,created_at:new Date().toISOString()},{success:!0};console.log("ğŸ” å°è¯•çœŸå®Supabaseç™»å½•...");const{data:i,error:l}=await n.auth.signInWithPassword({email:e,password:r});if(l){if(console.error("Supabaseç™»å½•é”™è¯¯:",l),l.status===400||l.message.includes("Invalid"))return console.warn("Supabaseé…ç½®æ— æ•ˆï¼Œå›é€€åˆ°å¼€å‘æ¨¡å¼"),s.value={id:"dev-user-id",email:e,user_metadata:{username:"devuser"}},a.value={id:"dev-user-id",username:"devuser",avatar_url:null,level:1,experience_points:0,signature:null,created_at:new Date().toISOString()},{success:!0};throw l}return i.user&&(s.value=i.user,await I(),console.log("âœ… çœŸå®Supabaseç™»å½•æˆåŠŸ")),{success:!0}}catch(t){return console.error("ç™»å½•é”™è¯¯:",t),{success:!1,error:t.message}}finally{p.value=!1}},z=async(e,r,t)=>{p.value=!0;try{const u="https://bkintupjzbcjiqvzricz.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!u||!i||u.includes("default.supabase.co")||i.includes("default")){console.warn("å¼€å‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿæ³¨å†Œæµç¨‹ï¼ˆçœŸå®Supabaseé…ç½®æ— æ•ˆï¼‰");const o={id:"mock-"+Date.now(),email:e,user_metadata:{username:t}};return(await h(o)).success&&console.log("âœ… å¼€å‘æ¨¡å¼ï¼šç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸ"),{success:!0,message:"å¼€å‘æ¨¡å¼ï¼šæ³¨å†ŒæˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰",user:o}}console.log("ğŸ” å°è¯•çœŸå®Supabaseæ³¨å†Œ...");const{data:l,error:c}=await n.auth.signUp({email:e,password:r,options:{data:{username:t}}});if(c){if(console.error("Supabaseæ³¨å†Œé”™è¯¯:",c),c.status===400||c.message.includes("Invalid")){console.warn("Supabaseé…ç½®æ— æ•ˆï¼Œå›é€€åˆ°å¼€å‘æ¨¡å¼");const o={id:"mock-"+Date.now(),email:e,user_metadata:{username:t}};return(await h(o)).success&&console.log("âœ… å¼€å‘æ¨¡å¼ï¼šç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸ"),{success:!0,message:"å¼€å‘æ¨¡å¼ï¼šæ³¨å†ŒæˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰",user:o}}throw c}if(console.log("âœ… çœŸå®Supabaseæ³¨å†ŒæˆåŠŸ"),l.user){console.log("ğŸ‘¤ ç¡®ä¿æ–°æ³¨å†Œç”¨æˆ·çš„èµ„æ–™å­˜åœ¨...");const o=await h(l.user);o.success?console.log("âœ… ç”¨æˆ·èµ„æ–™åˆ›å»º/è·å–æˆåŠŸ"):console.warn("âš ï¸ ç”¨æˆ·èµ„æ–™åˆ›å»ºå¤±è´¥:",o.error)}return{success:!0,user:l.user}}catch(u){return console.error("æ³¨å†Œé”™è¯¯:",u),{success:!1,error:u.message}}finally{p.value=!1}},d=async e=>{if(a.value)try{a.value.experience_points+=e;const r=a.value.level,u=(c=>{const o=[0,50,150,300,500,800,1200,1800,2500,3500,5e3,7e3,1e4];if(c<=1)return 0;if(c>=o.length){const _=o[o.length-1],M=c-o.length+1;return _+M*2e3}return o[c-1]})(r+1);a.value.experience_points>=u&&(a.value.level+=1,console.log(`ğŸ‰ æ­å–œå‡çº§ï¼å½“å‰ç­‰çº§: Lv.${a.value.level}`));const i="https://bkintupjzbcjiqvzricz.supabase.co",l="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!i||!l||i.includes("default.supabase.co")||l.includes("default")){console.log("å¼€å‘æ¨¡å¼ï¼šç»éªŒå€¼å·²æ›´æ–°åˆ°æœ¬åœ°çŠ¶æ€");return}await n.from("profiles").update({experience_points:a.value.experience_points,level:a.value.level,updated_at:new Date().toISOString()}).eq("id",a.value.id)}catch(r){console.error("æ›´æ–°ç»éªŒå€¼å¤±è´¥:",r),a.value.experience_points-=e,a.value.level>1&&(a.value.level-=1)}},m=async e=>{if(a.value)try{a.value.signature=e;const r="https://bkintupjzbcjiqvzricz.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!r||!t||r.includes("default.supabase.co")||t.includes("default")){console.log("å¼€å‘æ¨¡å¼ï¼šä¸ªæ€§ç­¾åå·²æ›´æ–°åˆ°æœ¬åœ°çŠ¶æ€"),localStorage.setItem("userSignature",e);return}await n.from("profiles").update({signature:e,updated_at:new Date().toISOString()}).eq("id",a.value.id),localStorage.setItem("userSignature",e)}catch(r){console.error("æ›´æ–°ä¸ªæ€§ç­¾åå¤±è´¥:",r),a.value&&(a.value.signature=a.value.signature||null)}},g=async(e,r)=>{var t;p.value=!0;try{const u="https://bkintupjzbcjiqvzricz.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!u||!i||u.includes("default.supabase.co")||i.includes("default"))return console.warn("å¼€å‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿå¯†ç ä¿®æ”¹"),{success:!0,message:"å¼€å‘æ¨¡å¼ï¼šå¯†ç ä¿®æ”¹æˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰"};const{error:l}=await n.auth.signInWithPassword({email:((t=s.value)==null?void 0:t.email)||"",password:e});if(l)return{success:!1,error:"å½“å‰å¯†ç é”™è¯¯"};const{error:c}=await n.auth.updateUser({password:r});return c?{success:!1,error:c.message}:{success:!0,message:"å¯†ç ä¿®æ”¹æˆåŠŸ"}}catch(u){return console.error("ä¿®æ”¹å¯†ç å¤±è´¥:",u),{success:!1,error:u.message}}finally{p.value=!1}},S=async e=>{var r;p.value=!0;try{const t="https://bkintupjzbcjiqvzricz.supabase.co",u="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraW50dXBqemJjamlxdnpyaWN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDYzNDEsImV4cCI6MjA3NzE4MjM0MX0.ZA6l95LSZ_x2DFfJGCcXMXLlRg9nOV7kNqEJUC7OG8o";if(!t||!u||t.includes("default.supabase.co")||u.includes("default"))return console.warn("å¼€å‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿè´¦å·åˆ é™¤"),s.value=null,a.value=null,{success:!0,message:"å¼€å‘æ¨¡å¼ï¼šè´¦å·åˆ é™¤æˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰"};const{error:i}=await n.auth.signInWithPassword({email:((r=s.value)==null?void 0:r.email)||"",password:e});if(i)return{success:!1,error:"å¯†ç é”™è¯¯"};a.value&&await n.from("profiles").delete().eq("id",a.value.id);try{const{error:l}=await n.auth.updateUser({data:{delete_requested:!0}});l&&console.warn("æ— æ³•æ ‡è®°åˆ é™¤è¯·æ±‚ï¼Œæ‰§è¡Œç™»å‡ºæ“ä½œ:",l),await n.auth.signOut()}catch(l){console.warn("åˆ é™¤ç”¨æˆ·æ—¶å‡ºé”™ï¼Œæ‰§è¡Œç™»å‡º:",l),await n.auth.signOut()}return s.value=null,a.value=null,{success:!0,message:"è´¦å·åˆ é™¤æˆåŠŸ"}}catch(t){return console.error("åˆ é™¤è´¦å·å¤±è´¥:",t),{success:!1,error:t.message}}finally{p.value=!1}},j=async()=>{const{error:e}=await n.auth.signOut();e||(s.value=null,a.value=null)};return n.auth.onAuthStateChange(async(e,r)=>{var t;console.log("ğŸ” è®¤è¯çŠ¶æ€å˜åŒ–:",e,(t=r==null?void 0:r.user)==null?void 0:t.id),e==="SIGNED_IN"&&(r!=null&&r.user)?(console.log("âœ… ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œè®¾ç½®ç”¨æˆ·ä¿¡æ¯"),s.value=r.user,await I()):e==="SIGNED_OUT"?(console.log("ğŸ‘‹ ç”¨æˆ·ç™»å‡ºï¼Œæ¸…é™¤ç”¨æˆ·ä¿¡æ¯"),s.value=null,a.value=null):e==="TOKEN_REFRESHED"?console.log("ğŸ”„ ä»¤ç‰Œå·²åˆ·æ–°"):e==="USER_UPDATED"&&console.log("ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°")}),{user:s,profile:a,isLoading:p,isAuthenticated:b,currentLevel:w,experiencePoints:v,initializeAuth:f,signIn:J,signUp:z,signOut:j,fetchProfile:I,updateExperience:d,updateSignature:m,changePassword:g,deleteAccount:S}});export{C as useAuthStore};
//# sourceMappingURL=auth-hIVPxf3j.js.map
