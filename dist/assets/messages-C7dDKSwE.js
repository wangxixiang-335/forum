import{L as U,r as p,y as n,z as v}from"./index-DvT1nwGZ.js";const h=async(l,i=3,_=1e3)=>{let f;for(let g=0;g<i;g++)try{return await l()}catch(y){if(f=y,g===i-1)throw y;await new Promise(q=>setTimeout(q,_*(g+1)))}throw f},z=U("messages",()=>{const l=p([]),i=p([]),_=p(!1),f=p(0);return{conversations:l,currentMessages:i,isLoading:_,unreadCount:f,fetchConversations:async()=>{_.value=!0;try{const{data:{user:e}}=await n.auth.getUser();if(!e)throw new Error("用户未登录");console.log("正在获取用户会话列表，用户ID:",e.id);const r="https://bkintupjzbcjiqvzricz.supabase.co";if(!r||r.includes("default.supabase.co")){console.log("开发模式：返回模拟会话数据");const o=[{id:"conv_mock1",user1_id:e.id,user2_id:"mock-user-1",other_user:{id:"mock-user-1",username:"测试用户1",avatar_url:null,level:2},last_message:{id:"msg1",content:"这是一条测试消息",created_at:new Date(Date.now()-36e5).toISOString(),is_read:!1},last_message_at:new Date(Date.now()-36e5).toISOString(),unread_count:1,messages:[]}];return l.value=o,{success:!0,data:o}}const{data:a,error:s}=await n.from("messages").select(`
          *,
          sender_profile:sender_id (username, avatar_url, level),
          receiver_profile:receiver_id (username, avatar_url, level)
        `).or(`sender_id.eq.${e.id},receiver_id.eq.${e.id}`).eq("is_deleted_by_sender",!1).eq("is_deleted_by_receiver",!1).order("created_at",{ascending:!1});if(s)throw console.error("获取消息失败:",s),s;console.log("获取到的消息数量:",(a==null?void 0:a.length)||0);const t=new Map;(Array.isArray(a)?a:[]).forEach(o=>{const d=o.sender_id===e.id?o.receiver_id:o.sender_id,b=o.sender_id===e.id?o.receiver_profile:o.sender_profile;t.has(d)||t.set(d,{id:`conv_${d}`,user1_id:e.id<d?e.id:d,user2_id:e.id>d?e.id:d,other_user:{...b,id:d},last_message:o,last_message_at:o.created_at,messages:[],unread_count:0});const w=t.get(d);w.messages.push(o),(!w.last_message||new Date(o.created_at)>new Date(w.last_message.created_at))&&(w.last_message=o,w.last_message_at=o.created_at),o.receiver_id===e.id&&!o.is_read&&w.unread_count++});const m=[];t.forEach(o=>{m.push(o)});const u=m.sort((o,d)=>{const b=new Date(o.last_message_at).getTime();return new Date(d.last_message_at).getTime()-b});return console.log("处理后的会话数量:",u.length),console.log("会话列表详情:",u),l.value=u,{success:!0,data:u}}catch(e){return console.error("获取会话列表失败:",e),{success:!1,error:v(e)}}finally{_.value=!1}},fetchMessages:async e=>{_.value=!0;try{const{data:{user:r}}=await n.auth.getUser();if(!r)throw new Error("用户未登录");console.log("获取会话消息，会话ID:",e,"用户ID:",r.id);const a="https://bkintupjzbcjiqvzricz.supabase.co";if(!a||a.includes("default.supabase.co")){console.log("开发模式：返回模拟消息数据");const u=[{id:"msg1",sender_id:"mock-user-1",receiver_id:r.id,content:"这是一条测试消息",is_read:!1,is_deleted_by_sender:!1,is_deleted_by_receiver:!1,created_at:new Date(Date.now()-36e5).toISOString(),updated_at:new Date(Date.now()-36e5).toISOString(),sender_profile:{username:"测试用户1",avatar_url:null,level:2},is_from_current_user:!1}];return i.value=u,{success:!0,data:i.value}}let s;if(e.startsWith("conv_"))s=e.replace("conv_","");else{const{data:u,error:o}=await h(()=>n.from("conversations").select("*").eq("id",e).single());if(o)throw o;if(!u)throw new Error("会话不存在");s=u.user1_id===r.id?u.user2_id:u.user1_id}const{data:t,error:c}=await n.from("messages").select(`
          *,
          sender_profile:sender_id (username, avatar_url, level)
        `).or(`and(sender_id.eq.${r.id},receiver_id.eq.${s}),and(sender_id.eq.${s},receiver_id.eq.${r.id})`).eq("is_deleted_by_sender",!1).eq("is_deleted_by_receiver",!1).order("created_at",{ascending:!0});if(c)throw console.error("获取消息失败:",c),c;console.log("获取到的消息数量:",(t==null?void 0:t.length)||0);const m=(t||[]).map(u=>({...u,is_from_current_user:u.sender_id===r.id}));return i.value=m,{success:!0,data:i.value}}catch(r){return console.error("获取消息失败:",r),{success:!1,error:v(r)}}finally{_.value=!1}},fetchMessagesPaginated:async(e,r=1,a=50)=>{_.value=!0;try{const{data:s,error:t}=await h(()=>n.from("messages").select(`
            *,
            sender_profile:sender_id (username, avatar_url, level),
            receiver_profile:receiver_id (username, avatar_url, level)
          `).or(`sender_id.in.(select user1_id from conversations where id.eq.${e}),sender_id.in.(select user2_id from conversations where id.eq.${e})`).and(`receiver_id.in.(select user1_id from conversations where id.eq.${e}),receiver_id.in.(select user2_id from conversations where id.eq.${e})`).order("created_at",{ascending:!1}).range((r-1)*a,r*a-1));if(t)throw t;return i.value=(s||[]).reverse(),{success:!0,data:i.value}}catch(s){return console.error("获取消息失败:",s),{success:!1,error:v(s)}}finally{_.value=!1}},sendMessage:async(e,r)=>{try{const{data:{user:a}}=await n.auth.getUser();if(!a)throw new Error("用户未登录");const{data:s,error:t}=await h(()=>n.from("messages").insert({sender_id:a.id,receiver_id:e,content:r.trim()}).select(`
            *,
            sender_profile:sender_id (username, avatar_url, level),
            receiver_profile:receiver_id (username, avatar_url, level)
          `).single());if(t)throw t;return s&&i.value.push(s),{success:!0,data:s}}catch(a){return console.error("发送消息失败:",a),{success:!1,error:v(a)}}},markMessagesAsRead:async e=>{try{console.log("标记消息已读，senderId:",e);const{data:{user:r}}=await n.auth.getUser();if(!r)return;if(!e||e==="undefined"){console.warn("senderId 无效，跳过标记已读");return}try{const{error:s}=await n.rpc("mark_messages_as_read",{p_sender_id:e,p_receiver_id:r.id});if(s)throw s}catch(s){console.warn("RPC函数不存在，使用直接更新:",s);const{error:t}=await h(()=>n.from("messages").update({is_read:!0}).eq("sender_id",e).eq("receiver_id",r.id).eq("is_read",!1));if(t)throw t}i.value=i.value.map(s=>s.sender_id===e&&s.receiver_id===r.id?{...s,is_read:!0}:s),l.value=l.value.map(s=>{var t;return((t=s.other_user)==null?void 0:t.id)===e?{...s,unread_count:0}:s});const a=l.value.find(s=>{var t;return((t=s.other_user)==null?void 0:t.id)===e});if(a&&a.unread_count===0){const s=i.value.filter(t=>t.sender_id===e&&t.receiver_id===r.id&&!t.is_read).length;f.value=Math.max(0,f.value-s)}return{success:!0}}catch(r){return console.error("标记消息已读失败:",r),{success:!1,error:v(r)}}},fetchUnreadCount:async()=>{try{const{data:{user:e}}=await n.auth.getUser();if(!e)return;const r="https://bkintupjzbcjiqvzricz.supabase.co";if(!r||r.includes("default.supabase.co"))return console.log("开发模式：返回模拟未读数量"),f.value=1,{success:!0,count:1};let a=0;try{const{data:s,error:t}=await n.rpc("get_unread_message_count",{p_user_id:e.id});if(!t&&s)a=s;else throw t}catch(s){console.warn("RPC函数不存在，使用直接查询:",s);const{data:t,error:c}=await h(()=>n.from("messages").select("*",{count:"exact",head:!0}).eq("receiver_id",e.id).eq("is_read",!1).eq("is_deleted_by_receiver",!1));if(c)throw c;a=t||0}return f.value=a,{success:!0,count:a}}catch(e){return console.error("获取未读消息数量失败:",e),f.value=0,{success:!1,error:v(e)}}},deleteConversation:async e=>{try{const{data:{user:r}}=await n.auth.getUser();if(!r)throw new Error("用户未登录");const a=l.value.find(c=>c.id===e);if(!a)throw new Error("会话不存在");const s=r.id===a.user1_id?"is_deleted_by_user1":"is_deleted_by_user2",{error:t}=await h(()=>n.from("conversations").update({[s]:!0}).eq("id",e));if(t)throw t;return l.value=l.value.filter(c=>c.id!==e),{success:!0}}catch(r){return console.error("删除会话失败:",r),{success:!1,error:v(r)}}},deleteMessage:async e=>{try{const{data:{user:r}}=await n.auth.getUser();if(!r)throw new Error("用户未登录");const a=i.value.find(c=>c.id===e);if(!a)throw new Error("消息不存在");const s=r.id===a.sender_id?"is_deleted_by_sender":"is_deleted_by_receiver",{error:t}=await h(()=>n.from("messages").update({[s]:!0}).eq("id",e));if(t)throw t;return i.value=i.value.filter(c=>c.id!==e),{success:!0}}catch(r){return console.error("删除消息失败:",r),{success:!1,error:v(r)}}},searchUsers:async e=>{try{const{data:r,error:a}=await h(()=>n.from("profiles").select("id, username, avatar_url, level").ilike("username",`%${e}%`).limit(10));if(a)throw a;return{success:!0,data:r||[]}}catch(r){return console.error("搜索用户失败:",r),{success:!1,error:v(r)}}}}});export{z as u};
//# sourceMappingURL=messages-C7dDKSwE.js.map
