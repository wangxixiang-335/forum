const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/auth-1hv12URH.js","assets/index-CtP2hjPR.js","assets/index-DZoKQPTh.css"])))=>i.map(i=>d[i]);
import{D as g,r as h,E as l,s as i,x as u,G as f}from"./index-CtP2hjPR.js";const L=g("posts",()=>{const w=h([]),_=h(null),d=h(!1),m=async(e=1,t=20)=>{d.value=!0;try{const{data:r,error:a}=await l(()=>i.from("posts").select(`
            *,
            profiles:user_id (username, avatar_url, level)
          `).order("created_at",{ascending:!1}).range((e-1)*t,e*t-1));if(a)throw a;r&&(w.value=r)}catch(r){throw console.error("获取帖子列表失败:",r),u(r)}finally{d.value=!1}},p=async e=>{d.value=!0;try{const{data:t,error:r}=await l(()=>i.from("posts").select(`
            *,
            profiles:user_id (username, avatar_url, level)
          `).eq("id",e).single());if(r)throw r;t&&(_.value=t,await q(e))}catch(t){throw console.error("获取帖子失败:",t),u(t)}finally{d.value=!1}},v=async(e,t,r=[])=>{var c;const{useAuthStore:a}=await f(async()=>{const{useAuthStore:s}=await import("./auth-1hv12URH.js");return{useAuthStore:s}},__vite__mapDeps([0,1,2])),o=a();if(!o.user)throw new Error("请先登录");try{const{data:s,error:n}=await l(()=>i.from("posts").insert({user_id:o.user.id,title:e,content:t,tags:r,like_count:0,comment_count:0,view_count:0,is_pinned:!1}).select().single());if(n)throw n;return await i.from("profiles").update({experience_points:i.rpc("increment",{x:((c=o.profile)==null?void 0:c.experience_points)||0,y:10})}).eq("id",o.user.id),{success:!0,data:s}}catch(s){return console.error("创建帖子失败:",s),{success:!1,error:u(s)}}},E=async e=>{var a;const{useAuthStore:t}=await f(async()=>{const{useAuthStore:o}=await import("./auth-1hv12URH.js");return{useAuthStore:o}},__vite__mapDeps([0,1,2])),r=t();if(!r.user)throw new Error("请先登录");try{const{data:o,error:c}=await i.from("interactions").select("id").eq("user_id",r.user.id).eq("target_type","post").eq("target_id",e).eq("interaction_type","like");if(c&&c.code!=="PGRST116")throw c;if(o&&o.length>0){const{error:s}=await i.from("interactions").delete().eq("user_id",r.user.id).eq("target_type","post").eq("target_id",e).eq("interaction_type","like");if(s)throw s;const{error:n}=await i.rpc("decrement_like_count",{post_id:e});n&&console.error("减少点赞数失败:",n)}else{const{error:s}=await i.from("interactions").insert({user_id:r.user.id,target_type:"post",target_id:e,interaction_type:"like"});if(s&&s.code==="23505"){console.log("检测到重复点赞，执行取消点赞");const{error:n}=await i.from("interactions").delete().eq("user_id",r.user.id).eq("target_type","post").eq("target_id",e).eq("interaction_type","like");if(n)throw n;const{error:y}=await i.rpc("decrement_like_count",{post_id:e});y&&console.error("减少点赞数失败:",y)}else{if(s)throw s;{const{error:n}=await i.rpc("increment_like_count",{post_id:e});n&&console.error("增加点赞数失败:",n)}}}return await m(),((a=_.value)==null?void 0:a.id)===e&&await p(e),{success:!0}}catch(o){return console.error("点赞操作失败:",o),{success:!1,error:u(o)}}},q=async e=>{try{await i.rpc("increment_view_count",{post_id:e})}catch(t){console.error("增加浏览量失败:",t)}};return{posts:w,currentPost:_,isLoading:d,fetchPosts:m,fetchPostById:p,fetchUserPosts:async e=>{try{const{data:t,error:r}=await l(()=>i.from("posts").select(`
            *,
            profiles:user_id (username, avatar_url, level)
          `).eq("user_id",e).order("created_at",{ascending:!1}));if(r)throw r;return{success:!0,data:t}}catch(t){return console.error("获取用户帖子失败:",t),{success:!1,error:u(t)}}},createPost:v,createComment:async(e,t,r)=>{var c;const{useAuthStore:a}=await f(async()=>{const{useAuthStore:s}=await import("./auth-1hv12URH.js");return{useAuthStore:s}},__vite__mapDeps([0,1,2])),o=a();if(!o.user)throw new Error("请先登录");try{const{data:s,error:n}=await l(()=>i.from("comments").insert({post_id:e,user_id:o.user.id,content:t,parent_id:r}).select().single());if(n)throw n;return await i.from("profiles").update({experience_points:(((c=o.profile)==null?void 0:c.experience_points)||0)+5}).eq("id",o.user.id),{success:!0,data:s}}catch(s){return console.error("创建评论失败:",s),{success:!1,error:u(s)}}},deletePost:async e=>{var a;const{useAuthStore:t}=await f(async()=>{const{useAuthStore:o}=await import("./auth-1hv12URH.js");return{useAuthStore:o}},__vite__mapDeps([0,1,2])),r=t();if(!r.user)throw new Error("请先登录");try{const{error:o}=await l(()=>i.from("posts").delete().eq("id",e).eq("user_id",r.user.id));if(o)throw o;return w.value=w.value.filter(c=>c.id!==e),((a=_.value)==null?void 0:a.id)===e&&(_.value=null),{success:!0}}catch(o){return console.error("删除帖子失败:",o),{success:!1,error:u(o)}}},deleteComment:async e=>{const{useAuthStore:t}=await f(async()=>{const{useAuthStore:a}=await import("./auth-1hv12URH.js");return{useAuthStore:a}},__vite__mapDeps([0,1,2])),r=t();if(!r.user)throw new Error("请先登录");try{const{error:a}=await l(()=>i.from("comments").delete().eq("id",e).eq("user_id",r.user.id));if(a)throw a;return{success:!0}}catch(a){return console.error("删除评论失败:",a),{success:!1,error:u(a)}}},toggleLike:E}});export{L as u};
//# sourceMappingURL=posts-BCS3gLhB.js.map
