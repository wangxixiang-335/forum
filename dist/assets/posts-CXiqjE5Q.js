const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/auth-hIVPxf3j.js","assets/index-DvT1nwGZ.js","assets/index-Cl7GcX7-.css"])))=>i.map(i=>d[i]);
import{L as W,r as p,y as c,M as f,z as _,J as v}from"./index-DvT1nwGZ.js";const Z=W("posts",()=>{const L=p([]),y=p(null),E=p(!1),R=p(0),A=p(1),C=p(20),S=p({sortBy:"newest",timeRange:"all",tags:[]}),q=async(t=1,e=20,s)=>{E.value=!0,A.value=t;try{const r=s||S.value;let o=c.from("posts").select(`
          *,
          profiles:user_id (username, avatar_url, level)
        `,{count:"exact"});o=O(o,r),o=I(o,r.sortBy);const n=(t-1)*e;o=o.range(n,n+e-1);const{data:a,error:l,count:g}=await f(()=>o);if(l)throw l;a&&(L.value=a,R.value=g||0)}catch(r){throw console.error("获取帖子列表失败:",r),_(r)}finally{E.value=!1}},O=(t,e)=>{e.tags&&e.tags.length>0&&(t=t.contains("tags",e.tags)),e.authorId&&(t=t.eq("user_id",e.authorId));const s=b(e.timeRange);return s&&(t=t.gte("created_at",s)),t},b=t=>{const e=new Date;switch(t){case"today":return new Date(e.setHours(0,0,0,0)).toISOString();case"week":return new Date(e.setDate(e.getDate()-7)).toISOString();case"month":return new Date(e.setMonth(e.getMonth()-1)).toISOString();case"year":return new Date(e.setFullYear(e.getFullYear()-1)).toISOString();default:return null}},I=(t,e)=>{switch(e){case"newest":return t.order("is_pinned",{ascending:!1}).order("created_at",{ascending:!1});case"oldest":return t.order("created_at",{ascending:!0});case"most_liked":return t.order("like_count",{ascending:!1}).order("created_at",{ascending:!1});case"most_commented":return t.order("comment_count",{ascending:!1}).order("created_at",{ascending:!1});case"most_viewed":return t.order("view_count",{ascending:!1}).order("created_at",{ascending:!1});default:return t.order("is_pinned",{ascending:!1}).order("created_at",{ascending:!1})}},U=t=>{S.value={...S.value,...t}},x=()=>{S.value={sortBy:"newest",timeRange:"all",tags:[]}},F=async(t=20)=>{try{const{data:e,error:s}=await f(()=>c.from("posts").select("tags").not("tags","eq","{}").limit(1e3));if(s)throw s;const r={};return e==null||e.forEach(n=>{var a;(a=n.tags)==null||a.forEach(l=>{r[l]=(r[l]||0)+1})}),{success:!0,data:Object.entries(r).sort(([,n],[,a])=>a-n).slice(0,t).map(([n,a])=>({tag:n,count:a}))}}catch(e){return console.error("获取热门标签失败:",e),{success:!1,error:_(e)}}},k=async t=>{E.value=!0;try{const{data:e,error:s}=await f(()=>c.from("posts").select(`
            *,
            profiles:user_id (username, avatar_url, level),
            post_images!left(*)
          `).eq("id",t).single());if(s)throw s;e&&(y.value=e,await z(t))}catch(e){throw console.error("获取帖子失败:",e),_(e)}finally{E.value=!1}},V=async(t,e)=>{const{useAuthStore:s}=await v(async()=>{const{useAuthStore:o}=await import("./auth-hIVPxf3j.js");return{useAuthStore:o}},__vite__mapDeps([0,1,2])),r=s();if(!r.user)throw new Error("请先登录");try{const o=e.name.split(".").pop(),n=`${Date.now()}-${Math.random().toString(36).substr(2,9)}.${o}`,a=`post-images/${t}/${n}`,{data:l,error:g}=await c.storage.from("post-images").upload(a,e);if(g)throw console.error("图片上传失败:",g),new Error(`图片上传失败: ${g.message}`);const{data:w}=c.storage.from("post-images").getPublicUrl(a);if(!(w!=null&&w.publicUrl))throw new Error("无法获取图片公开URL");const{data:i,error:d}=await c.from("post_images").insert({post_id:t,user_id:r.user.id,image_url:w.publicUrl,file_name:e.name,file_size:e.size,mime_type:e.type}).select().single();if(d){console.error("创建图片记录失败:",d);try{await c.storage.from("post-images").remove([a])}catch(P){console.warn("删除已上传文件失败:",P)}throw d}return{success:!0,data:i}}catch(o){return console.error("上传帖子图片失败:",o),{success:!1,error:{message:o.message||"图片上传失败",code:o.code}}}},M=async(t,e,s=[],r=[])=>{var l,g,w;const{useAuthStore:o}=await v(async()=>{const{useAuthStore:i}=await import("./auth-hIVPxf3j.js");return{useAuthStore:i}},__vite__mapDeps([0,1,2])),n=o();if(!n.user)throw new Error("请先登录");let a=[];try{console.log("开始创建帖子:",{title:t.substring(0,50)+"...",contentLength:e.length,tags:s,imageCount:r.length,userId:n.user.id});const i={user_id:n.user.id,title:t,content:e,tags:s,like_count:0,comment_count:0,view_count:0,is_pinned:!1,has_images:r.length>0};console.log("插入数据准备完成，开始数据库操作..."),console.log("开始数据库插入操作，内容长度:",e.length);const{data:d,error:P}=await f(()=>c.from("posts").insert(i).select("id").single());if(P)throw console.error("插入帖子数据失败:",P),P;console.log("插入成功，获取完整帖子数据...");const{data:h,error:D}=await f(()=>c.from("posts").select("*").eq("id",d.id).single());if(D)return console.error("查询帖子数据失败:",D),{success:!0,postId:d.id,warning:"帖子创建成功，但获取详情失败"};if(console.log("帖子创建成功:",{id:h==null?void 0:h.id,title:((l=h==null?void 0:h.title)==null?void 0:l.substring(0,30))+"..."}),r.length>0&&h){console.log("开始上传图片，数量:",r.length),a=await Promise.allSettled(r.map(m=>V(h.id,m))),console.log("图片上传结果:",a);const u=a.filter(m=>m.status==="fulfilled"&&m.value&&m.value.success),T=a.filter(m=>m.status==="rejected"||m.status==="fulfilled"&&m.value&&!m.value.success);if(T.length>0&&(console.warn("部分图片上传失败:",T.length),u.length>0&&console.log("部分图片上传成功:",u.length)),u.length>0){const m=u[0];try{await c.from("posts").update({cover_image_url:m.value.data.image_url,updated_at:new Date().toISOString()}).eq("id",h.id),console.log("封面图片设置成功")}catch(G){console.warn("设置封面图片失败:",G)}}}try{await n.updateExperience(10),console.log("用户经验值更新成功")}catch(u){console.warn("更新经验值失败，但帖子已创建成功:",u)}return{success:!0,data:h,imageUploads:{total:r.length,successful:a?a.filter(u=>u.status==="fulfilled"&&u.value&&u.value.success).length:0,failed:a?a.filter(u=>u.status==="rejected"||u.status==="fulfilled"&&u.value&&!u.value.success).length:0}}}catch(i){console.error("创建帖子失败:",i);let d=i.message||"创建帖子失败";return(g=i.message)!=null&&g.includes("timeout")||(w=i.message)!=null&&w.includes("超时")?d=`发布超时（${e.length}字），请检查网络连接或稍后重试`:i.code==="PGRST301"?d="数据库连接失败，请检查网络连接":i.code==="PGRST116"?d="认证失败，请重新登录":i.code==="23505"?d="帖子已存在或发生唯一性冲突":i.code==="23503"?d="用户不存在或权限不足":i.code==="23502"&&(d="数据不完整，请检查必填字段"),{success:!1,error:{message:d,code:i.code,details:i.message,contentLength:e.length}}}},$=async t=>{var r;const{useAuthStore:e}=await v(async()=>{const{useAuthStore:o}=await import("./auth-hIVPxf3j.js");return{useAuthStore:o}},__vite__mapDeps([0,1,2])),s=e();if(!s.user)throw new Error("请先登录");try{console.log("toggleLike: 开始点赞操作",{postId:t,userId:s.user.id});const{data:o,error:n}=await c.from("interactions").select("id").eq("user_id",s.user.id).eq("target_type","post").eq("target_id",t).eq("interaction_type","like");if(n&&n.code!=="PGRST116")throw n;if(console.log("toggleLike: 现有点赞记录",o),o&&o.length>0){console.log("toggleLike: 执行取消点赞");const{error:a}=await c.from("interactions").delete().eq("user_id",s.user.id).eq("target_type","post").eq("target_id",t).eq("interaction_type","like");if(a)throw a;console.log("toggleLike: 取消点赞成功")}else{console.log("toggleLike: 执行点赞");const{error:a}=await c.from("interactions").insert({user_id:s.user.id,target_type:"post",target_id:t,interaction_type:"like"});if(a&&a.code==="23505"){console.log("toggleLike: 检测到重复点赞，执行取消点赞");const{error:l}=await c.from("interactions").delete().eq("user_id",s.user.id).eq("target_type","post").eq("target_id",t).eq("interaction_type","like");if(l)throw l;console.log("toggleLike: 重复点赞处理完成")}else{if(a)throw a;console.log("toggleLike: 点赞成功")}}return await q(),((r=y.value)==null?void 0:r.id)===t&&await k(t),{success:!0}}catch(o){return console.error("点赞操作失败:",o),{success:!1,error:_(o)}}},z=async t=>{var e;try{await c.rpc("increment_view_count",{post_id:t})}catch(s){if((s==null?void 0:s.code)==="PGRST202"||(e=s==null?void 0:s.message)!=null&&e.includes("function")){console.warn("increment_view_count函数不存在，使用直接更新方式");const{error:r}=await c.from("posts").update({view_count:c.sql`view_count + 1`}).eq("id",t);r&&console.error("直接更新浏览量失败:",r)}else console.error("增加浏览量失败:",s)}};return{posts:L,currentPost:y,isLoading:E,totalPosts:R,currentPage:A,pageSize:C,filters:S,fetchPosts:q,fetchPostById:k,fetchUserPosts:async t=>{try{const{data:e,error:s}=await f(()=>c.from("posts").select(`
            *,
            profiles:user_id (username, avatar_url, level)
          `).eq("user_id",t).order("created_at",{ascending:!1}));if(s)throw s;return{success:!0,data:e}}catch(e){return console.error("获取用户帖子失败:",e),{success:!1,error:_(e)}}},fetchCommentsWithReplies:async(t,e=1,s=20)=>{try{const{data:r,error:o}=await f(()=>c.from("comments").select(`
            *,
            profiles:user_id (username, avatar_url, level)
          `).eq("post_id",t).is("parent_id",null).order("is_pinned",{ascending:!1}).order("created_at",{ascending:!1}).range((e-1)*s,e*s-1));if(o)throw o;return{success:!0,data:await Promise.all((r||[]).map(async a=>{const{data:l,error:g}=await f(()=>c.from("comments").select(`
                *,
                profiles:user_id (username, avatar_url, level)
              `).eq("parent_id",a.id).order("created_at",{ascending:!1}).limit(5));return g?(console.warn("获取评论回复失败:",g),{...a,replies:[]}):{...a,replies:l||[]}}))}}catch(r){return console.error("获取评论失败:",r),{success:!1,error:_(r)}}},fetchCommentReplies:async(t,e=1,s=10)=>{try{const{data:r,error:o}=await f(()=>c.from("comments").select(`
            *,
            profiles:user_id (username, avatar_url, level)
          `).eq("parent_id",t).order("created_at",{ascending:!1}).range((e-1)*s,e*s-1));if(o)throw o;const{count:n}=await c.from("comments").select("*",{count:"exact",head:!0}).eq("parent_id",t),a=Math.ceil((n||0)/s),l=e<a;return{success:!0,data:r||[],hasMore:l,currentPage:e,totalPages:a}}catch(r){return console.error("获取评论回复失败:",r),{success:!1,error:_(r)}}},createPost:M,createComment:async(t,e,s)=>{const{useAuthStore:r}=await v(async()=>{const{useAuthStore:n}=await import("./auth-hIVPxf3j.js");return{useAuthStore:n}},__vite__mapDeps([0,1,2])),o=r();if(!o.user)throw new Error("请先登录");try{const{data:n,error:a}=await f(()=>c.from("comments").insert({post_id:t,user_id:o.user.id,content:e,parent_id:s}).select().single());if(a)throw a;return await o.updateExperience(5),{success:!0,data:n}}catch(n){return console.error("创建评论失败:",n),{success:!1,error:_(n)}}},deletePost:async t=>{var r;const{useAuthStore:e}=await v(async()=>{const{useAuthStore:o}=await import("./auth-hIVPxf3j.js");return{useAuthStore:o}},__vite__mapDeps([0,1,2])),s=e();if(!s.user)throw new Error("请先登录");try{const{error:o}=await f(()=>c.from("posts").delete().eq("id",t).eq("user_id",s.user.id));if(o)throw o;return L.value=L.value.filter(n=>n.id!==t),((r=y.value)==null?void 0:r.id)===t&&(y.value=null),{success:!0}}catch(o){return console.error("删除帖子失败:",o),{success:!1,error:_(o)}}},deleteComment:async t=>{const{useAuthStore:e}=await v(async()=>{const{useAuthStore:r}=await import("./auth-hIVPxf3j.js");return{useAuthStore:r}},__vite__mapDeps([0,1,2])),s=e();if(!s.user)throw new Error("请先登录");try{const{error:r}=await f(()=>c.from("comments").delete().eq("id",t).eq("user_id",s.user.id));if(r)throw r;return{success:!0}}catch(r){return console.error("删除评论失败:",r),{success:!1,error:_(r)}}},toggleCommentPin:async(t,e)=>{var o;const{useAuthStore:s}=await v(async()=>{const{useAuthStore:n}=await import("./auth-hIVPxf3j.js");return{useAuthStore:n}},__vite__mapDeps([0,1,2])),r=s();if(!r.user)throw new Error("请先登录");try{const{data:n,error:a}=await c.from("comments").select("is_pinned, user_id, post_id").eq("id",t).single();if(a)throw a;const l=((o=r.profile)==null?void 0:o.level)||1,g=r.user.id===n.post_id;if(!(l>=10||g))return{success:!1,error:{message:"只有Lv.10以上用户或帖子作者才能置顶评论"}};const{error:i}=await f(()=>c.from("comments").update({is_pinned:!n.is_pinned,updated_at:new Date().toISOString()}).eq("id",t));if(i)throw i;return{success:!0,data:{is_pinned:!n.is_pinned}}}catch(n){return console.error("切换评论置顶状态失败:",n),{success:!1,error:_(n)}}},toggleLike:$,updateFilters:U,resetFilters:x,getPopularTags:F}});export{Z as u};
//# sourceMappingURL=posts-CXiqjE5Q.js.map
