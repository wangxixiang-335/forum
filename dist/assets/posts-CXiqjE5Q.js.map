{"version":3,"mappings":"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","names":["usePostsStore","defineStore","posts","ref","currentPost","isLoading","totalPosts","currentPage","pageSize","filters","fetchPosts","page","limit","customFilters","activeFilters","queryBuilder","supabase","applyFilters","applySorting","offset","data","error","count","withRetry","handleSupabaseError","timeFilter","getTimeFilter","timeRange","now","sortBy","updateFilters","newFilters","resetFilters","getPopularTags","tagCounts","post","_a","tag","a","b","fetchPostById","postId","incrementViewCount","uploadPostImage","file","useAuthStore","__vitePreload","authStore","fileExt","fileName","filePath","uploadData","uploadError","urlData","imageData","imageError","deleteError","createPost","title","content","tags","images","uploadResults","insertData","insertResult","insertError","postData","selectError","successfulUploads","result","failedUploads","firstImage","coverError","expError","r","errorMessage","_b","_c","toggleLike","existingLike","checkError","updateError","userId","topLevelComments","topLevelError","comment","replies","repliesError","commentId","totalPages","hasMore","parentId","commentData","commentError","userLevel","isPostAuthor"],"ignoreList":[],"sources":["../../src/stores/posts.ts"],"sourcesContent":["import { defineStore } from 'pinia'\r\nimport { ref } from 'vue'\r\nimport { supabase, withRetry, handleSupabaseError } from '@/services/supabase'\r\nimport type { Database } from '@/types/supabase'\r\n\r\ntype Post = Database['public']['Tables']['posts']['Row'] & {\r\n  profiles: {\r\n    username: string\r\n    avatar_url: string | null\r\n    level: number\r\n  }\r\n  post_images?: Database['public']['Tables']['post_images']['Row'][]\r\n  user_has_liked?: boolean\r\n}\r\n\r\ninterface PostFilters {\r\n  sortBy: 'newest' | 'oldest' | 'most_liked' | 'most_commented' | 'most_viewed'\r\n  timeRange: 'all' | 'today' | 'week' | 'month' | 'year'\r\n  tags?: string[]\r\n  authorId?: string\r\n}\r\n\r\nexport const usePostsStore = defineStore('posts', () => {\r\n  const posts = ref<Post[]>([])\r\n  const currentPost = ref<Post | null>(null)\r\n  const isLoading = ref(false)\r\n  const totalPosts = ref(0)\r\n  const currentPage = ref(1)\r\n  const pageSize = ref(20)\r\n  const filters = ref<PostFilters>({\r\n    sortBy: 'newest',\r\n    timeRange: 'all',\r\n    tags: []\r\n  })\r\n\r\n  // 获取帖子列表\r\n  const fetchPosts = async (page = 1, limit = 20, customFilters?: PostFilters) => {\r\n    isLoading.value = true\r\n    currentPage.value = page\r\n    \r\n    try {\r\n      const activeFilters = customFilters || filters.value\r\n      let queryBuilder = supabase\r\n        .from('posts')\r\n        .select(`\r\n          *,\r\n          profiles:user_id (username, avatar_url, level)\r\n        `, { count: 'exact' })\r\n\r\n      // 应用过滤器\r\n      queryBuilder = applyFilters(queryBuilder, activeFilters)\r\n\r\n      // 应用排序\r\n      queryBuilder = applySorting(queryBuilder, activeFilters.sortBy)\r\n\r\n      // 应用分页\r\n      const offset = (page - 1) * limit\r\n      queryBuilder = queryBuilder.range(offset, offset + limit - 1)\r\n\r\n      const { data, error, count } = await withRetry(() => queryBuilder)\r\n\r\n      if (error) throw error\r\n      \r\n      if (data) {\r\n        posts.value = data as Post[]\r\n        totalPosts.value = count || 0\r\n      }\r\n    } catch (error: any) {\r\n      console.error('获取帖子列表失败:', error)\r\n      throw handleSupabaseError(error)\r\n    } finally {\r\n      isLoading.value = false\r\n    }\r\n  }\r\n\r\n  // 应用过滤器\r\n  const applyFilters = (queryBuilder: any, filters: PostFilters) => {\r\n    // 标签过滤\r\n    if (filters.tags && filters.tags.length > 0) {\r\n      queryBuilder = queryBuilder.contains('tags', filters.tags)\r\n    }\r\n\r\n    // 作者过滤\r\n    if (filters.authorId) {\r\n      queryBuilder = queryBuilder.eq('user_id', filters.authorId)\r\n    }\r\n\r\n    // 时间范围过滤\r\n    const timeFilter = getTimeFilter(filters.timeRange)\r\n    if (timeFilter) {\r\n      queryBuilder = queryBuilder.gte('created_at', timeFilter)\r\n    }\r\n\r\n    return queryBuilder\r\n  }\r\n\r\n  // 获取时间过滤器\r\n  const getTimeFilter = (timeRange: string) => {\r\n    const now = new Date()\r\n    switch (timeRange) {\r\n      case 'today':\r\n        return new Date(now.setHours(0, 0, 0, 0)).toISOString()\r\n      case 'week':\r\n        return new Date(now.setDate(now.getDate() - 7)).toISOString()\r\n      case 'month':\r\n        return new Date(now.setMonth(now.getMonth() - 1)).toISOString()\r\n      case 'year':\r\n        return new Date(now.setFullYear(now.getFullYear() - 1)).toISOString()\r\n      default:\r\n        return null\r\n    }\r\n  }\r\n\r\n  // 应用排序\r\n  const applySorting = (queryBuilder: any, sortBy: string) => {\r\n    switch (sortBy) {\r\n      case 'newest':\r\n        return queryBuilder.order('is_pinned', { ascending: false }).order('created_at', { ascending: false })\r\n      case 'oldest':\r\n        return queryBuilder.order('created_at', { ascending: true })\r\n      case 'most_liked':\r\n        return queryBuilder.order('like_count', { ascending: false }).order('created_at', { ascending: false })\r\n      case 'most_commented':\r\n        return queryBuilder.order('comment_count', { ascending: false }).order('created_at', { ascending: false })\r\n      case 'most_viewed':\r\n        return queryBuilder.order('view_count', { ascending: false }).order('created_at', { ascending: false })\r\n      default:\r\n        return queryBuilder.order('is_pinned', { ascending: false }).order('created_at', { ascending: false })\r\n    }\r\n  }\r\n\r\n  // 更新过滤器\r\n  const updateFilters = (newFilters: Partial<PostFilters>) => {\r\n    filters.value = { ...filters.value, ...newFilters }\r\n  }\r\n\r\n  // 重置过滤器\r\n  const resetFilters = () => {\r\n    filters.value = {\r\n      sortBy: 'newest',\r\n      timeRange: 'all',\r\n      tags: []\r\n    }\r\n  }\r\n\r\n  // 获取热门标签\r\n  const getPopularTags = async (limit = 20) => {\r\n    try {\r\n      const { data, error } = await withRetry(() =>\r\n        supabase\r\n          .from('posts')\r\n          .select('tags')\r\n          .not('tags', 'eq', '{}')\r\n          .limit(1000)\r\n      )\r\n\r\n      if (error) throw error\r\n\r\n      // 统计标签频率\r\n      const tagCounts: { [key: string]: number } = {}\r\n      data?.forEach(post => {\r\n        post.tags?.forEach(tag => {\r\n          tagCounts[tag] = (tagCounts[tag] || 0) + 1\r\n        })\r\n      })\r\n\r\n      // 排序并返回热门标签\r\n      const popularTags = Object.entries(tagCounts)\r\n        .sort(([, a], [, b]) => b - a)\r\n        .slice(0, limit)\r\n        .map(([tag, count]) => ({ tag, count }))\r\n\r\n      return { success: true, data: popularTags }\r\n    } catch (error: any) {\r\n      console.error('获取热门标签失败:', error)\r\n      return { success: false, error: handleSupabaseError(error) }\r\n    }\r\n  }\r\n\r\n  // 获取单个帖子\r\n  const fetchPostById = async (postId: string) => {\r\n    isLoading.value = true\r\n    try {\r\n      const { data, error } = await withRetry(() =>\r\n        supabase\r\n          .from('posts')\r\n          .select(`\r\n            *,\r\n            profiles:user_id (username, avatar_url, level),\r\n            post_images!left(*)\r\n          `)\r\n          .eq('id', postId)\r\n          .single()\r\n      )\r\n\r\n      if (error) throw error\r\n      \r\n      if (data) {\r\n        currentPost.value = data as Post\r\n        \r\n        // 增加浏览量\r\n        await incrementViewCount(postId)\r\n      }\r\n    } catch (error: any) {\r\n      console.error('获取帖子失败:', error)\r\n      throw handleSupabaseError(error)\r\n    } finally {\r\n      isLoading.value = false\r\n    }\r\n  }\r\n\r\n  // 上传帖子图片\r\n  const uploadPostImage = async (postId: string, file: File) => {\r\n    const { useAuthStore } = await import('@/stores/auth')\r\n    const authStore = useAuthStore()\r\n    \r\n    if (!authStore.user) {\r\n      throw new Error('请先登录')\r\n    }\r\n\r\n    try {\r\n      // 生成唯一的文件名\r\n      const fileExt = file.name.split('.').pop()\r\n      const fileName = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${fileExt}`\r\n      const filePath = `post-images/${postId}/${fileName}`\r\n\r\n      // 上传文件到Supabase Storage\r\n      const { data: uploadData, error: uploadError } = await supabase.storage\r\n        .from('post-images')\r\n        .upload(filePath, file)\r\n\r\n      if (uploadError) {\r\n        console.error('图片上传失败:', uploadError)\r\n        throw new Error(`图片上传失败: ${uploadError.message}`)\r\n      }\r\n\r\n      // 获取公开URL\r\n      const { data: urlData } = supabase.storage\r\n        .from('post-images')\r\n        .getPublicUrl(filePath)\r\n\r\n      if (!urlData?.publicUrl) {\r\n        throw new Error('无法获取图片公开URL')\r\n      }\r\n\r\n      // 创建图片记录\r\n      const { data: imageData, error: imageError } = await supabase\r\n        .from('post_images')\r\n        .insert({\r\n          post_id: postId,\r\n          user_id: authStore.user.id,\r\n          image_url: urlData.publicUrl,\r\n          file_name: file.name,\r\n          file_size: file.size,\r\n          mime_type: file.type\r\n        })\r\n        .select()\r\n        .single()\r\n\r\n      if (imageError) {\r\n        console.error('创建图片记录失败:', imageError)\r\n        \r\n        // 如果创建记录失败，尝试删除已上传的文件\r\n        try {\r\n          await supabase.storage\r\n            .from('post-images')\r\n            .remove([filePath])\r\n        } catch (deleteError) {\r\n          console.warn('删除已上传文件失败:', deleteError)\r\n        }\r\n        \r\n        throw imageError\r\n      }\r\n\r\n      return { success: true, data: imageData }\r\n    } catch (error: any) {\r\n      console.error('上传帖子图片失败:', error)\r\n      return { \r\n        success: false, \r\n        error: { \r\n          message: error.message || '图片上传失败',\r\n          code: error.code\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // 创建帖子（支持图片上传）\r\n  const createPost = async (title: string, content: string, tags: string[] = [], images: File[] = []) => {\r\n    const { useAuthStore } = await import('@/stores/auth')\r\n    const authStore = useAuthStore()\r\n    \r\n    if (!authStore.user) {\r\n      throw new Error('请先登录')\r\n    }\r\n\r\n    let uploadResults: any[] = []\r\n\r\n    try {\r\n      console.log('开始创建帖子:', { \r\n        title: title.substring(0, 50) + '...', \r\n        contentLength: content.length, \r\n        tags,\r\n        imageCount: images.length,\r\n        userId: authStore.user.id\r\n      })\r\n      \r\n      // 准备插入数据\r\n      const insertData = {\r\n        user_id: authStore.user.id,\r\n        title,\r\n        content,\r\n        tags,\r\n        like_count: 0,\r\n        comment_count: 0,\r\n        view_count: 0,\r\n        is_pinned: false,\r\n        has_images: images.length > 0\r\n      }\r\n\r\n      console.log('插入数据准备完成，开始数据库操作...')\r\n      \r\n      // 创建帖子 - 简化插入操作，避免触发器影响\r\n      console.log('开始数据库插入操作，内容长度:', content.length)\r\n      \r\n      // 使用异步方式插入，先插入数据，再查询结果\r\n      const { data: insertResult, error: insertError } = await withRetry(() =>\r\n        supabase\r\n          .from('posts')\r\n          .insert(insertData)\r\n          .select('id')\r\n          .single()\r\n      )\r\n      \r\n      if (insertError) {\r\n        console.error('插入帖子数据失败:', insertError)\r\n        throw insertError\r\n      }\r\n      \r\n      // 使用单独的查询获取完整的帖子数据\r\n      console.log('插入成功，获取完整帖子数据...')\r\n      const { data: postData, error: selectError } = await withRetry(() =>\r\n        supabase\r\n          .from('posts')\r\n          .select('*')\r\n          .eq('id', insertResult.id)\r\n          .single()\r\n      )\r\n      \r\n      if (selectError) {\r\n        console.error('查询帖子数据失败:', selectError)\r\n        // 即使查询失败，如果插入成功，仍然返回成功\r\n        return { \r\n          success: true, \r\n          postId: insertResult.id,\r\n          warning: '帖子创建成功，但获取详情失败'\r\n        }\r\n      }\r\n\r\n      // 如果到达这里，说明插入和查询都成功\r\n      console.log('帖子创建成功:', { id: postData?.id, title: postData?.title?.substring(0, 30) + '...' })\r\n\r\n      // 如果有图片，上传图片\r\n      if (images.length > 0 && postData) {\r\n        console.log('开始上传图片，数量:', images.length)\r\n        \r\n        uploadResults = await Promise.allSettled(\r\n          images.map(file => uploadPostImage(postData.id, file))\r\n        )\r\n\r\n        console.log('图片上传结果:', uploadResults)\r\n\r\n        // 检查上传结果\r\n        const successfulUploads = uploadResults.filter(result => \r\n          result.status === 'fulfilled' && result.value && result.value.success\r\n        )\r\n        \r\n        const failedUploads = uploadResults.filter(result => \r\n          result.status === 'rejected' || (result.status === 'fulfilled' && result.value && !result.value.success)\r\n        )\r\n\r\n        if (failedUploads.length > 0) {\r\n          console.warn('部分图片上传失败:', failedUploads.length)\r\n          \r\n          // 如果有图片上传失败，但帖子已创建成功，返回警告信息\r\n          if (successfulUploads.length > 0) {\r\n            console.log('部分图片上传成功:', successfulUploads.length)\r\n          }\r\n        }\r\n\r\n        // 设置第一张图片为封面图片\r\n        if (successfulUploads.length > 0) {\r\n          const firstImage = successfulUploads[0] as PromiseFulfilledResult<any>\r\n          try {\r\n            await supabase\r\n              .from('posts')\r\n              .update({ \r\n                cover_image_url: firstImage.value.data.image_url,\r\n                updated_at: new Date().toISOString()\r\n              })\r\n              .eq('id', postData.id)\r\n            console.log('封面图片设置成功')\r\n          } catch (coverError) {\r\n            console.warn('设置封面图片失败:', coverError)\r\n          }\r\n        }\r\n      }\r\n      \r\n      // 增加用户经验值（发帖获得10点经验）\r\n      try {\r\n        await authStore.updateExperience(10)\r\n        console.log('用户经验值更新成功')\r\n      } catch (expError) {\r\n        console.warn('更新经验值失败，但帖子已创建成功:', expError)\r\n      }\r\n      \r\n      return { \r\n        success: true, \r\n        data: postData,\r\n        imageUploads: {\r\n          total: images.length,\r\n          successful: uploadResults ? uploadResults.filter(r => r.status === 'fulfilled' && r.value && r.value.success).length : 0,\r\n          failed: uploadResults ? uploadResults.filter(r => r.status === 'rejected' || (r.status === 'fulfilled' && r.value && !r.value.success)).length : 0\r\n        }\r\n      }\r\n    } catch (error: any) {\r\n      console.error('创建帖子失败:', error)\r\n      \r\n      // 提供更详细和友好的错误信息\r\n      let errorMessage = error.message || '创建帖子失败'\r\n      \r\n      if (error.message?.includes('timeout') || error.message?.includes('超时')) {\r\n        errorMessage = `发布超时（${content.length}字），请检查网络连接或稍后重试`\r\n      } else if (error.code === 'PGRST301') {\r\n        errorMessage = '数据库连接失败，请检查网络连接'\r\n      } else if (error.code === 'PGRST116') {\r\n        errorMessage = '认证失败，请重新登录'\r\n      } else if (error.code === '23505') {\r\n        errorMessage = '帖子已存在或发生唯一性冲突'\r\n      } else if (error.code === '23503') {\r\n        errorMessage = '用户不存在或权限不足'\r\n      } else if (error.code === '23502') {\r\n        errorMessage = '数据不完整，请检查必填字段'\r\n      }\r\n      \r\n      return { \r\n        success: false, \r\n        error: { \r\n          message: errorMessage,\r\n          code: error.code,\r\n          details: error.message,\r\n          contentLength: content.length\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // 点赞/取消点赞\r\n  const toggleLike = async (postId: string) => {\r\n    const { useAuthStore } = await import('@/stores/auth')\r\n    const authStore = useAuthStore()\r\n    \r\n    if (!authStore.user) {\r\n      throw new Error('请先登录')\r\n    }\r\n\r\n    try {\r\n      console.log('toggleLike: 开始点赞操作', { postId, userId: authStore.user.id })\r\n      \r\n      // 检查是否已经点赞\r\n      const { data: existingLike, error: checkError } = await supabase\r\n        .from('interactions')\r\n        .select('id')\r\n        .eq('user_id', authStore.user.id)\r\n        .eq('target_type', 'post')\r\n        .eq('target_id', postId)\r\n        .eq('interaction_type', 'like')\r\n\r\n      if (checkError && checkError.code !== 'PGRST116') {\r\n        throw checkError\r\n      }\r\n\r\n      console.log('toggleLike: 现有点赞记录', existingLike)\r\n\r\n      if (existingLike && existingLike.length > 0) {\r\n        // 取消点赞\r\n        console.log('toggleLike: 执行取消点赞')\r\n        const { error: deleteError } = await supabase\r\n          .from('interactions')\r\n          .delete()\r\n          .eq('user_id', authStore.user.id)\r\n          .eq('target_type', 'post')\r\n          .eq('target_id', postId)\r\n          .eq('interaction_type', 'like')\r\n        \r\n        if (deleteError) throw deleteError\r\n        console.log('toggleLike: 取消点赞成功')\r\n      } else {\r\n        // 点赞\r\n        console.log('toggleLike: 执行点赞')\r\n        const { error: insertError } = await supabase\r\n          .from('interactions')\r\n          .insert({\r\n            user_id: authStore.user.id,\r\n            target_type: 'post',\r\n            target_id: postId,\r\n            interaction_type: 'like'\r\n          })\r\n        \r\n        // 如果是重复点赞错误，说明已经点赞过了，执行取消点赞逻辑\r\n        if (insertError && insertError.code === '23505') {\r\n          console.log('toggleLike: 检测到重复点赞，执行取消点赞')\r\n          const { error: deleteError } = await supabase\r\n            .from('interactions')\r\n            .delete()\r\n            .eq('user_id', authStore.user.id)\r\n            .eq('target_type', 'post')\r\n            .eq('target_id', postId)\r\n            .eq('interaction_type', 'like')\r\n          \r\n          if (deleteError) throw deleteError\r\n          console.log('toggleLike: 重复点赞处理完成')\r\n        } else if (insertError) {\r\n          throw insertError\r\n        } else {\r\n          console.log('toggleLike: 点赞成功')\r\n        }\r\n      }\r\n\r\n      // 更新本地状态\r\n      await fetchPosts()\r\n      if (currentPost.value?.id === postId) {\r\n        await fetchPostById(postId)\r\n      }\r\n\r\n      return { success: true }\r\n    } catch (error: any) {\r\n      console.error('点赞操作失败:', error)\r\n      return { success: false, error: handleSupabaseError(error) }\r\n    }\r\n  }\r\n\r\n  // 增加浏览量\r\n  const incrementViewCount = async (postId: string) => {\r\n    try {\r\n      await supabase.rpc('increment_view_count', { post_id: postId })\r\n    } catch (error: any) {\r\n      // 如果函数不存在，使用直接更新方式\r\n      if (error?.code === 'PGRST202' || error?.message?.includes('function')) {\r\n        console.warn('increment_view_count函数不存在，使用直接更新方式')\r\n        const { error: updateError } = await supabase\r\n          .from('posts')\r\n          .update({ view_count: supabase.sql`view_count + 1` })\r\n          .eq('id', postId)\r\n        \r\n        if (updateError) {\r\n          console.error('直接更新浏览量失败:', updateError)\r\n        }\r\n      } else {\r\n        console.error('增加浏览量失败:', error)\r\n      }\r\n    }\r\n  }\r\n\r\n  // 获取用户帖子\r\n  const fetchUserPosts = async (userId: string) => {\r\n    try {\r\n      const { data, error } = await withRetry(() =>\r\n        supabase\r\n          .from('posts')\r\n          .select(`\r\n            *,\r\n            profiles:user_id (username, avatar_url, level)\r\n          `)\r\n          .eq('user_id', userId)\r\n          .order('created_at', { ascending: false })\r\n      )\r\n\r\n      if (error) throw error\r\n      \r\n      return { success: true, data }\r\n    } catch (error: any) {\r\n      console.error('获取用户帖子失败:', error)\r\n      return { success: false, error: handleSupabaseError(error) }\r\n    }\r\n  }\r\n\r\n  // 获取评论及其回复\r\n  const fetchCommentsWithReplies = async (postId: string, page = 1, limit = 20) => {\r\n    try {\r\n      // 获取顶级评论（没有parent_id的评论）\r\n      const { data: topLevelComments, error: topLevelError } = await withRetry(() =>\r\n        supabase\r\n          .from('comments')\r\n          .select(`\r\n            *,\r\n            profiles:user_id (username, avatar_url, level)\r\n          `)\r\n          .eq('post_id', postId)\r\n          .is('parent_id', null)\r\n          .order('is_pinned', { ascending: false })\r\n          .order('created_at', { ascending: false })\r\n          .range((page - 1) * limit, page * limit - 1)\r\n      )\r\n\r\n      if (topLevelError) throw topLevelError\r\n\r\n      // 为每个顶级评论获取回复\r\n      const commentsWithReplies = await Promise.all(\r\n        (topLevelComments || []).map(async (comment) => {\r\n          const { data: replies, error: repliesError } = await withRetry(() =>\r\n            supabase\r\n              .from('comments')\r\n              .select(`\r\n                *,\r\n                profiles:user_id (username, avatar_url, level)\r\n              `)\r\n              .eq('parent_id', comment.id)\r\n              .order('created_at', { ascending: false })\r\n              .limit(5) // 限制回复数量，可以添加\"加载更多\"功能\r\n          )\r\n\r\n          if (repliesError) {\r\n            console.warn('获取评论回复失败:', repliesError)\r\n            return { ...comment, replies: [] }\r\n          }\r\n\r\n          return { ...comment, replies: replies || [] }\r\n        })\r\n      )\r\n\r\n      return { success: true, data: commentsWithReplies }\r\n    } catch (error: any) {\r\n      console.error('获取评论失败:', error)\r\n      return { success: false, error: handleSupabaseError(error) }\r\n    }\r\n  }\r\n\r\n  // 获取评论回复\r\n  const fetchCommentReplies = async (commentId: string, page = 1, limit = 10) => {\r\n    try {\r\n      const { data, error } = await withRetry(() =>\r\n        supabase\r\n          .from('comments')\r\n          .select(`\r\n            *,\r\n            profiles:user_id (username, avatar_url, level)\r\n          `)\r\n          .eq('parent_id', commentId)\r\n          .order('created_at', { ascending: false })\r\n          .range((page - 1) * limit, page * limit - 1)\r\n      )\r\n\r\n      if (error) throw error\r\n\r\n      // 获取总数以计算是否有更多回复\r\n      const { count } = await supabase\r\n        .from('comments')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('parent_id', commentId)\r\n\r\n      const totalPages = Math.ceil((count || 0) / limit)\r\n      const hasMore = page < totalPages\r\n\r\n      return { \r\n        success: true, \r\n        data: data || [], \r\n        hasMore,\r\n        currentPage: page,\r\n        totalPages\r\n      }\r\n    } catch (error: any) {\r\n      console.error('获取评论回复失败:', error)\r\n      return { success: false, error: handleSupabaseError(error) }\r\n    }\r\n  }\r\n\r\n  // 创建评论\r\n  const createComment = async (postId: string, content: string, parentId?: string) => {\r\n    const { useAuthStore } = await import('@/stores/auth')\r\n    const authStore = useAuthStore()\r\n    \r\n    if (!authStore.user) {\r\n      throw new Error('请先登录')\r\n    }\r\n\r\n    try {\r\n      const { data, error } = await withRetry(() =>\r\n        supabase\r\n          .from('comments')\r\n          .insert({\r\n            post_id: postId,\r\n            user_id: authStore.user.id,\r\n            content,\r\n            parent_id: parentId\r\n          })\r\n          .select()\r\n          .single()\r\n      )\r\n\r\n      if (error) throw error\r\n      \r\n      // 增加用户经验值（评论获得5点经验）\r\n      await authStore.updateExperience(5)\r\n      \r\n      return { success: true, data }\r\n    } catch (error: any) {\r\n      console.error('创建评论失败:', error)\r\n      return { success: false, error: handleSupabaseError(error) }\r\n    }\r\n  }\r\n\r\n  // 删除帖子\r\n  const deletePost = async (postId: string) => {\r\n    const { useAuthStore } = await import('@/stores/auth')\r\n    const authStore = useAuthStore()\r\n    \r\n    if (!authStore.user) {\r\n      throw new Error('请先登录')\r\n    }\r\n\r\n    try {\r\n      const { error } = await withRetry(() =>\r\n        supabase\r\n          .from('posts')\r\n          .delete()\r\n          .eq('id', postId)\r\n          .eq('user_id', authStore.user.id)\r\n      )\r\n\r\n      if (error) throw error\r\n      \r\n      // 从本地状态中移除帖子\r\n      posts.value = posts.value.filter(post => post.id !== postId)\r\n      if (currentPost.value?.id === postId) {\r\n        currentPost.value = null\r\n      }\r\n      \r\n      return { success: true }\r\n    } catch (error: any) {\r\n      console.error('删除帖子失败:', error)\r\n      return { success: false, error: handleSupabaseError(error) }\r\n    }\r\n  }\r\n\r\n  // 删除评论\r\n  const deleteComment = async (commentId: string) => {\r\n    const { useAuthStore } = await import('@/stores/auth')\r\n    const authStore = useAuthStore()\r\n    \r\n    if (!authStore.user) {\r\n      throw new Error('请先登录')\r\n    }\r\n\r\n    try {\r\n      const { error } = await withRetry(() =>\r\n        supabase\r\n          .from('comments')\r\n          .delete()\r\n          .eq('id', commentId)\r\n          .eq('user_id', authStore.user.id)\r\n      )\r\n\r\n      if (error) throw error\r\n      \r\n      return { success: true }\r\n    } catch (error: any) {\r\n      console.error('删除评论失败:', error)\r\n      return { success: false, error: handleSupabaseError(error) }\r\n    }\r\n  }\r\n\r\n  // 置顶/取消置顶评论\r\n  const toggleCommentPin = async (commentId: string, postId: string) => {\r\n    const { useAuthStore } = await import('@/stores/auth')\r\n    const authStore = useAuthStore()\r\n    \r\n    if (!authStore.user) {\r\n      throw new Error('请先登录')\r\n    }\r\n\r\n    try {\r\n      // 首先获取评论信息，检查权限\r\n      const { data: commentData, error: commentError } = await supabase\r\n        .from('comments')\r\n        .select('is_pinned, user_id, post_id')\r\n        .eq('id', commentId)\r\n        .single()\r\n\r\n      if (commentError) throw commentError\r\n\r\n      // 检查权限：只有10级以上用户或帖子作者可以置顶评论\r\n      const userLevel = authStore.profile?.level || 1\r\n      const isPostAuthor = authStore.user.id === commentData.post_id\r\n      const hasPermission = userLevel >= 10 || isPostAuthor\r\n\r\n      if (!hasPermission) {\r\n        return { \r\n          success: false, \r\n          error: { message: '只有Lv.10以上用户或帖子作者才能置顶评论' }\r\n        }\r\n      }\r\n\r\n      // 切换置顶状态\r\n      const { error } = await withRetry(() =>\r\n        supabase\r\n          .from('comments')\r\n          .update({ \r\n            is_pinned: !commentData.is_pinned,\r\n            updated_at: new Date().toISOString()\r\n          })\r\n          .eq('id', commentId)\r\n      )\r\n\r\n      if (error) throw error\r\n      \r\n      return { \r\n        success: true, \r\n        data: { is_pinned: !commentData.is_pinned }\r\n      }\r\n    } catch (error: any) {\r\n      console.error('切换评论置顶状态失败:', error)\r\n      return { success: false, error: handleSupabaseError(error) }\r\n    }\r\n  }\r\n\r\n  return {\r\n    posts,\r\n    currentPost,\r\n    isLoading,\r\n    totalPosts,\r\n    currentPage,\r\n    pageSize,\r\n    filters,\r\n    fetchPosts,\r\n    fetchPostById,\r\n    fetchUserPosts,\r\n    fetchCommentsWithReplies,\r\n    fetchCommentReplies,\r\n    createPost,\r\n    createComment,\r\n    deletePost,\r\n    deleteComment,\r\n    toggleCommentPin,\r\n    toggleLike,\r\n    updateFilters,\r\n    resetFilters,\r\n    getPopularTags\r\n  }\r\n})"],"file":"assets/posts-CXiqjE5Q.js"}