const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/auth-DsvB8qh0.js","assets/index-02sh5J2l.js","assets/index-DZoKQPTh.css"])))=>i.map(i=>d[i]);
import{I as T,r as d,x as c,J as l,y as u,G as w}from"./index-02sh5J2l.js";const G=T("posts",()=>{const h=d([]),f=d(null),_=d(!1),p=d(0),v=d(1),E=d(20),g=d({sortBy:"newest",timeRange:"all",tags:[]}),y=async(t=1,e=20,s)=>{_.value=!0,v.value=t;try{const o=s||g.value;let r=c.from("posts").select(`
          *,
          profiles:user_id (username, avatar_url, level)
        `,{count:"exact"});r=P(r,o),r=L(r,o.sortBy);const a=(t-1)*e;r=r.range(a,a+e-1);const{data:n,error:i,count:m}=await l(()=>r);if(i)throw i;n&&(h.value=n,p.value=m||0)}catch(o){throw console.error("获取帖子列表失败:",o),u(o)}finally{_.value=!1}},P=(t,e)=>{e.tags&&e.tags.length>0&&(t=t.contains("tags",e.tags)),e.authorId&&(t=t.eq("user_id",e.authorId));const s=k(e.timeRange);return s&&(t=t.gte("created_at",s)),t},k=t=>{const e=new Date;switch(t){case"today":return new Date(e.setHours(0,0,0,0)).toISOString();case"week":return new Date(e.setDate(e.getDate()-7)).toISOString();case"month":return new Date(e.setMonth(e.getMonth()-1)).toISOString();case"year":return new Date(e.setFullYear(e.getFullYear()-1)).toISOString();default:return null}},L=(t,e)=>{switch(e){case"newest":return t.order("is_pinned",{ascending:!1}).order("created_at",{ascending:!1});case"oldest":return t.order("created_at",{ascending:!0});case"most_liked":return t.order("like_count",{ascending:!1}).order("created_at",{ascending:!1});case"most_commented":return t.order("comment_count",{ascending:!1}).order("created_at",{ascending:!1});case"most_viewed":return t.order("view_count",{ascending:!1}).order("created_at",{ascending:!1});default:return t.order("is_pinned",{ascending:!1}).order("created_at",{ascending:!1})}},R=t=>{g.value={...g.value,...t}},A=()=>{g.value={sortBy:"newest",timeRange:"all",tags:[]}},q=async(t=20)=>{try{const{data:e,error:s}=await l(()=>c.from("posts").select("tags").not("tags","eq","{}").limit(1e3));if(s)throw s;const o={};return e==null||e.forEach(a=>{var n;(n=a.tags)==null||n.forEach(i=>{o[i]=(o[i]||0)+1})}),{success:!0,data:Object.entries(o).sort(([,a],[,n])=>n-a).slice(0,t).map(([a,n])=>({tag:a,count:n}))}}catch(e){return console.error("获取热门标签失败:",e),{success:!1,error:u(e)}}},S=async t=>{_.value=!0;try{const{data:e,error:s}=await l(()=>c.from("posts").select(`
            *,
            profiles:user_id (username, avatar_url, level)
          `).eq("id",t).single());if(s)throw s;e&&(f.value=e,await O(t))}catch(e){throw console.error("获取帖子失败:",e),u(e)}finally{_.value=!1}},D=async(t,e,s=[])=>{const{useAuthStore:o}=await w(async()=>{const{useAuthStore:a}=await import("./auth-DsvB8qh0.js");return{useAuthStore:a}},__vite__mapDeps([0,1,2])),r=o();if(!r.user)throw new Error("请先登录");try{const{data:a,error:n}=await l(()=>c.from("posts").insert({user_id:r.user.id,title:t,content:e,tags:s,like_count:0,comment_count:0,view_count:0,is_pinned:!1}).select().single());if(n)throw n;return await r.updateExperience(10),{success:!0,data:a}}catch(a){return console.error("创建帖子失败:",a),{success:!1,error:u(a)}}},C=async t=>{var o;const{useAuthStore:e}=await w(async()=>{const{useAuthStore:r}=await import("./auth-DsvB8qh0.js");return{useAuthStore:r}},__vite__mapDeps([0,1,2])),s=e();if(!s.user)throw new Error("请先登录");try{console.log("toggleLike: 开始点赞操作",{postId:t,userId:s.user.id});const{data:r,error:a}=await c.from("interactions").select("id").eq("user_id",s.user.id).eq("target_type","post").eq("target_id",t).eq("interaction_type","like");if(a&&a.code!=="PGRST116")throw a;if(console.log("toggleLike: 现有点赞记录",r),r&&r.length>0){console.log("toggleLike: 执行取消点赞");const{error:n}=await c.from("interactions").delete().eq("user_id",s.user.id).eq("target_type","post").eq("target_id",t).eq("interaction_type","like");if(n)throw n;console.log("toggleLike: 取消点赞成功")}else{console.log("toggleLike: 执行点赞");const{error:n}=await c.from("interactions").insert({user_id:s.user.id,target_type:"post",target_id:t,interaction_type:"like"});if(n&&n.code==="23505"){console.log("toggleLike: 检测到重复点赞，执行取消点赞");const{error:i}=await c.from("interactions").delete().eq("user_id",s.user.id).eq("target_type","post").eq("target_id",t).eq("interaction_type","like");if(i)throw i;console.log("toggleLike: 重复点赞处理完成")}else{if(n)throw n;console.log("toggleLike: 点赞成功")}}return await y(),((o=f.value)==null?void 0:o.id)===t&&await S(t),{success:!0}}catch(r){return console.error("点赞操作失败:",r),{success:!1,error:u(r)}}},O=async t=>{try{await c.rpc("increment_view_count",{post_id:t})}catch(e){console.error("增加浏览量失败:",e)}};return{posts:h,currentPost:f,isLoading:_,totalPosts:p,currentPage:v,pageSize:E,filters:g,fetchPosts:y,fetchPostById:S,fetchUserPosts:async t=>{try{const{data:e,error:s}=await l(()=>c.from("posts").select(`
            *,
            profiles:user_id (username, avatar_url, level)
          `).eq("user_id",t).order("created_at",{ascending:!1}));if(s)throw s;return{success:!0,data:e}}catch(e){return console.error("获取用户帖子失败:",e),{success:!1,error:u(e)}}},fetchCommentsWithReplies:async(t,e=1,s=20)=>{try{const{data:o,error:r}=await l(()=>c.from("comments").select(`
            *,
            profiles:user_id (username, avatar_url, level)
          `).eq("post_id",t).is("parent_id",null).order("is_pinned",{ascending:!1}).order("created_at",{ascending:!1}).range((e-1)*s,e*s-1));if(r)throw r;return{success:!0,data:await Promise.all((o||[]).map(async n=>{const{data:i,error:m}=await l(()=>c.from("comments").select(`
                *,
                profiles:user_id (username, avatar_url, level)
              `).eq("parent_id",n.id).order("created_at",{ascending:!1}).limit(5));return m?(console.warn("获取评论回复失败:",m),{...n,replies:[]}):{...n,replies:i||[]}}))}}catch(o){return console.error("获取评论失败:",o),{success:!1,error:u(o)}}},fetchCommentReplies:async(t,e=1,s=10)=>{try{const{data:o,error:r}=await l(()=>c.from("comments").select(`
            *,
            profiles:user_id (username, avatar_url, level)
          `).eq("parent_id",t).order("created_at",{ascending:!1}).range((e-1)*s,e*s-1));if(r)throw r;const{count:a}=await c.from("comments").select("*",{count:"exact",head:!0}).eq("parent_id",t),n=Math.ceil((a||0)/s),i=e<n;return{success:!0,data:o||[],hasMore:i,currentPage:e,totalPages:n}}catch(o){return console.error("获取评论回复失败:",o),{success:!1,error:u(o)}}},createPost:D,createComment:async(t,e,s)=>{const{useAuthStore:o}=await w(async()=>{const{useAuthStore:a}=await import("./auth-DsvB8qh0.js");return{useAuthStore:a}},__vite__mapDeps([0,1,2])),r=o();if(!r.user)throw new Error("请先登录");try{const{data:a,error:n}=await l(()=>c.from("comments").insert({post_id:t,user_id:r.user.id,content:e,parent_id:s}).select().single());if(n)throw n;return await r.updateExperience(5),{success:!0,data:a}}catch(a){return console.error("创建评论失败:",a),{success:!1,error:u(a)}}},deletePost:async t=>{var o;const{useAuthStore:e}=await w(async()=>{const{useAuthStore:r}=await import("./auth-DsvB8qh0.js");return{useAuthStore:r}},__vite__mapDeps([0,1,2])),s=e();if(!s.user)throw new Error("请先登录");try{const{error:r}=await l(()=>c.from("posts").delete().eq("id",t).eq("user_id",s.user.id));if(r)throw r;return h.value=h.value.filter(a=>a.id!==t),((o=f.value)==null?void 0:o.id)===t&&(f.value=null),{success:!0}}catch(r){return console.error("删除帖子失败:",r),{success:!1,error:u(r)}}},deleteComment:async t=>{const{useAuthStore:e}=await w(async()=>{const{useAuthStore:o}=await import("./auth-DsvB8qh0.js");return{useAuthStore:o}},__vite__mapDeps([0,1,2])),s=e();if(!s.user)throw new Error("请先登录");try{const{error:o}=await l(()=>c.from("comments").delete().eq("id",t).eq("user_id",s.user.id));if(o)throw o;return{success:!0}}catch(o){return console.error("删除评论失败:",o),{success:!1,error:u(o)}}},toggleLike:C,updateFilters:R,resetFilters:A,getPopularTags:q}});export{G as u};
//# sourceMappingURL=posts-t7kwi12e.js.map
